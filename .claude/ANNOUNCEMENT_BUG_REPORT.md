# üêõ UK CRM - –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏

**–î–∞—Ç–∞:** 2026-01-06
**–ü—Ä–æ–±–ª–µ–º–∞:** –ñ–∏—Ç–µ–ª–∏ –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ—Ç –î–∏—Ä–µ–∫—Ç–æ—Ä–∞/–ú–µ–Ω–µ–¥–∂–µ—Ä–∞
**–°—Ç–∞—Ç—É—Å:** üî¥ **–ù–ê–ô–î–ï–ù–û 2 –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ë–ê–ì–ê**

---

## üìä EXECUTIVE SUMMARY

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í–ª–∏—è–Ω–∏–µ |
|---|----------|-------------|-----------|---------|
| 1 | **WebSocket –Ω–µ —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ `building_id` –∏–∑ announcement** | üî¥ –ö–†–ò–¢–ò–ß–ù–û | ConnectionManager.ts:417 | –ñ–∏—Ç–µ–ª–∏ –ù–ï –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |
| 2 | **–¢–∏–ø 'employees' –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ WebSocket** | üü° –í–´–°–û–ö–û | ConnectionManager.ts:169-178 | –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –ù–ï –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è |

---

## üîç –ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó

### 1. –ö–ê–ö –î–û–õ–ñ–ù–ê –†–ê–ë–û–¢–ê–¢–¨ –°–ò–°–¢–ï–ú–ê

```
–î–∏—Ä–µ–∫—Ç–æ—Ä/–ú–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
         ‚Üì
API —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ DB (/api/announcements POST)
         ‚Üì
WebSocket (ConnectionManager) polling –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
         ‚Üì
–û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –Ω–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ hash change
         ‚Üì
Broadcast UPDATE –≤—Å–µ–º –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
         ‚Üì
Frontend –ø–æ–ª—É—á–∞–µ—Ç real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
         ‚Üì
–ñ–∏—Ç–µ–ª–∏/–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –Ω–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
```

### 2. –ß–¢–û –ü–†–û–ò–°–•–û–î–ò–¢ –°–ï–ô–ß–ê–° (–ë–ê–ì–û–í–û)

```
–î–∏—Ä–µ–∫—Ç–æ—Ä/–ú–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ ‚úÖ
         ‚Üì
API —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å ‚úÖ
         ‚Üì
WebSocket –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚úÖ
         ‚Üì
‚ùå –ë–ê–ì #1: –°–º–æ—Ç—Ä–∏—Ç –Ω–∞ building_id (–∫–æ—Ç–æ—Ä–æ–≥–æ –ù–ï–¢ –≤ announcements!)
         ‚Üì
‚ùå –ë–ê–ì #2: –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ `announcements:all`
         ‚Üì
üî¥ –†–ï–ó–£–õ–¨–¢–ê–¢: Broadcast –ù–ï –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –∂–∏—Ç–µ–ª–µ–π –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
```

---

## üêõ –ë–ê–ì #1: WebSocket —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π building_id

### –õ–æ–∫–∞—Ü–∏—è: `cloudflare/src/ConnectionManager.ts:414-431`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
// Lines 414-431
// Also broadcast to specific buildings
const buildingAnnouncements = new Map<string, any[]>();
results.forEach((a: any) => {
  if (a.building_id) {  // ‚ùå –ü–†–û–ë–õ–ï–ú–ê: a.building_id –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢!
    if (!buildingAnnouncements.has(a.building_id)) {
      buildingAnnouncements.set(a.building_id, []);
    }
    buildingAnnouncements.get(a.building_id)!.push(a);
  }
});

buildingAnnouncements.forEach((announcements, buildingId) => {
  this.broadcastUpdate({
    type: 'announcement_update',
    data: { announcements },
    channels: [`announcements:building:${buildingId}`],  // ‚ùå –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è!
  });
});
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –±–∞–≥:**

**–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (schema.sql:780-798):**
```sql
CREATE TABLE IF NOT EXISTS announcements (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('residents', 'employees', 'all')),
  target_type TEXT,
  target_building_id TEXT,  -- ‚úÖ –ï–°–¢–¨ target_building_id
  target_entrance TEXT,
  target_floor TEXT,
  target_logins TEXT,
  -- ...
  building_id TEXT MISSING!  -- ‚ùå –ù–ï–¢ building_id
);
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ:** `target_building_id` (–Ω–µ `building_id`)

### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –±–∞–≥–∞ #1:

```
‚ùå Broadcast –≤ channel `announcements:building:123` –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
‚ùå –ñ–∏—Ç–µ–ª–∏, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –Ω–∞ `announcements:building:X`, –ù–ï –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚ùå –û–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ manual refresh (fetchAnnouncements)
```

---

## üêõ –ë–ê–ì #2: –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ announcements

### –õ–æ–∫–∞—Ü–∏—è: `cloudflare/src/ConnectionManager.ts:169-181`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
// Lines 160-181
private getUserSubscriptionChannels(userId: string, role: string, buildingId?: string | null): Set<string> {
  const subs = new Set<string>();

  if (role === 'resident') {
    // ... –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –∂–∏—Ç–µ–ª–µ–π
    if (buildingId) {
      subs.add(`announcements:building:${buildingId}`);  // ‚úÖ –ï—Å—Ç—å
    }
  } else if (role === 'executor') {
    subs.add(`requests:executor:${userId}`);
    subs.add(`requests:new`);
    // ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ù–ï–¢ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ announcements!
  } else if (['manager', 'admin', 'director', 'dispatcher', 'department_head'].includes(role)) {
    subs.add(`requests:all`);
    subs.add(`meetings:all`);
    subs.add(`announcements:all`);  // ‚úÖ –ï—Å—Ç—å
    subs.add(`chat:all`);
  }

  return subs;
}
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ Residents: –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ `announcements:building:X`
- ‚úÖ Managers/Admin/Director: –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ `announcements:all`
- ‚ùå Executors: **–ù–ï –ø–æ–¥–ø–∏—Å–∞–Ω—ã** –Ω–∞ announcements –≤–æ–æ–±—â–µ!

### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –±–∞–≥–∞ #2:

```
‚ùå –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –ù–ï –ø–æ–ª—É—á–∞—é—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
‚ùå –¢–∏–ø –æ–±—ä—è–≤–ª–µ–Ω–∏—è 'employees' –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –≤ real-time
‚ùå –û–±—ä—è–≤–ª–µ–Ω–∏—è –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ manual refresh
```

---

## üìù PROOF OF CONCEPT - –ö–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏

### –®–∞–≥ 1: –î–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
```javascript
// Frontend: AnnouncementsPage.tsx
await addAnnouncement({
  title: "–¢–µ—Å—Ç–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ",
  content: "–î–ª—è –≤—Å–µ—Ö –∂–∏—Ç–µ–ª–µ–π",
  type: 'residents',
  priority: 'urgent',
  target: { type: 'building', buildingId: 'building-123' }
});
```

### –®–∞–≥ 2: Backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ
```sql
-- cloudflare/src/index.ts:2301-2310
INSERT INTO announcements (
  id, title, content, type,
  target_type, target_building_id,  -- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ
  ...
) VALUES (?, ?, ?, ?, ?, ?, ...);
```

### –®–∞–≥ 3: WebSocket polling –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ
```typescript
// ConnectionManager.ts:387-405
const { results } = await this.env.DB.prepare(`
  SELECT * FROM announcements
  WHERE updated_at > datetime('now', '-24 hours')
  ...
`).all();

// results[0] = {
//   id: 'abc123',
//   target_building_id: 'building-123',  // ‚úÖ –ï—Å—Ç—å
//   building_id: undefined  // ‚ùå –ù–ï–¢!
// }
```

### –®–∞–≥ 4: Broadcast (BUGGY)
```typescript
// ConnectionManager.ts:414-431
results.forEach((a: any) => {
  if (a.building_id) {  // ‚ùå –í–°–ï–ì–î–ê FALSE!
    // –≠—Ç–æ—Ç –∫–æ–¥ –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
  }
});

// –ò—Ç–æ–≥: broadcast –∏–¥–µ—Ç —Ç–æ–ª—å–∫–æ –≤ 'announcements:all'
this.broadcastUpdate({
  type: 'announcement_update',
  data: { announcements: results },
  channels: ['announcements:all'],  // –¢–æ–ª—å–∫–æ —ç—Ç–æ!
});
```

### –®–∞–≥ 5: –ö—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ?
```typescript
// ConnectionManager.ts:169-181
// ‚úÖ Managers/Admin/Director - –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ 'announcements:all'
// ‚ùå Residents - –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ 'announcements:building:X', –Ω–µ –ø–æ–ª—É—á–∞—é—Ç
// ‚ùå Executors - –≤–æ–æ–±—â–µ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã, –Ω–µ –ø–æ–ª—É—á–∞—é—Ç
```

---

## üéØ –†–ï–®–ï–ù–ò–ï

### –§–∏–∫—Å #1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å ConnectionManager.ts:417

**–ë—ã–ª–æ:**
```typescript
if (a.building_id) {  // ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```typescript
if (a.target_building_id) {  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```typescript
// Line 417
- if (a.building_id) {
+ if (a.target_building_id) {

// Line 418
- if (!buildingAnnouncements.has(a.building_id)) {
+ if (!buildingAnnouncements.has(a.target_building_id)) {

// Line 419
- buildingAnnouncements.set(a.building_id, []);
+ buildingAnnouncements.set(a.target_building_id, []);

// Line 421
- buildingAnnouncements.get(a.building_id)!.push(a);
+ buildingAnnouncements.get(a.target_building_id)!.push(a);
```

### –§–∏–∫—Å #2: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è executors

**–ë—ã–ª–æ:**
```typescript
else if (role === 'executor') {
  subs.add(`requests:executor:${userId}`);
  subs.add(`requests:new`);
  // ‚ùå –ù–µ—Ç announcements
}
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```typescript
else if (role === 'executor') {
  subs.add(`requests:executor:${userId}`);
  subs.add(`requests:new`);
  subs.add(`announcements:all`);  // ‚úÖ –î–æ–±–∞–≤–∏—Ç—å!
}
```

### –§–∏–∫—Å #3 (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –¢–∞—Ä–≥–µ—Ç–∏–Ω–≥ –ø–æ —Ç–∏–ø—É

–ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å, —á—Ç–æ–±—ã broadcast —É—á–∏—Ç—ã–≤–∞–ª —Ç–∏–ø:

```typescript
// ConnectionManager.ts:408-413
this.broadcastUpdate({
  type: 'announcement_update',
  data: { announcements: results },
  channels: [
    'announcements:all',  // –í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã/–∞–¥–º–∏–Ω—ã
    ...(results.some(a => a.type === 'employees') ? ['announcements:staff'] : [])
  ],
});
```

---

## ‚úÖ EXPECTED BEHAVIOR –ü–û–°–õ–ï –§–ò–ö–°–ê

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –∂–∏—Ç–µ–ª–µ–π –∑–¥–∞–Ω–∏—è
```
1. –î–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:
   - type: 'residents'
   - target_building_id: 'building-123'

2. WebSocket –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ

3. Broadcast –≤ channels:
   - 'announcements:all' ‚Üí –ú–µ–Ω–µ–¥–∂–µ—Ä—ã/–ê–¥–º–∏–Ω—ã ‚úÖ
   - 'announcements:building:building-123' ‚Üí –ñ–∏—Ç–µ–ª–∏ –∑–¥–∞–Ω–∏—è 123 ‚úÖ

4. –†–µ–∑—É–ª—å—Ç–∞—Ç:
   - ‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –≤–∏–¥—è—Ç –≤ real-time
   - ‚úÖ –ñ–∏—Ç–µ–ª–∏ –∑–¥–∞–Ω–∏—è 123 –≤–∏–¥—è—Ç –≤ real-time
   - ‚úÖ –ñ–∏—Ç–µ–ª–∏ –¥—Ä—É–≥–∏—Ö –∑–¥–∞–Ω–∏–π –ù–ï –≤–∏–¥—è—Ç (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
```
1. –î–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:
   - type: 'employees'
   - target_type: 'all'

2. WebSocket –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ

3. Broadcast –≤ channels:
   - 'announcements:all' ‚Üí –ú–µ–Ω–µ–¥–∂–µ—Ä—ã/–ê–¥–º–∏–Ω—ã ‚úÖ
   - (–ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ #2) ‚Üí –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ ‚úÖ

4. –†–µ–∑—É–ª—å—Ç–∞—Ç:
   - ‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –≤–∏–¥—è—Ç –≤ real-time
   - ‚úÖ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –≤ real-time
   - ‚úÖ –ñ–∏—Ç–µ–ª–∏ –ù–ï –≤–∏–¥—è—Ç (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–¥—ä–µ–∑–¥–∞
```
1. –î–∏—Ä–µ–∫—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:
   - type: 'residents'
   - target_building_id: 'building-123'
   - target_entrance: '2'

2. WebSocket broadcast:
   - 'announcements:all' ‚Üí –ú–µ–Ω–µ–¥–∂–µ—Ä—ã ‚úÖ
   - 'announcements:building:building-123' ‚Üí –í—Å–µ –∂–∏—Ç–µ–ª–∏ –∑–¥–∞–Ω–∏—è ‚úÖ

3. Frontend —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (getAnnouncementsForResidents):
   - –ñ–∏—Ç–µ–ª–∏ –ø–æ–¥—ä–µ–∑–¥–∞ 2 ‚Üí –í–ò–î–Ø–¢ ‚úÖ
   - –ñ–∏—Ç–µ–ª–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–¥—ä–µ–∑–¥–æ–≤ ‚Üí –ù–ï –í–ò–î–Ø–¢ ‚úÖ (—Ñ–∏–ª—å—Ç—Ä –Ω–∞ frontend)
```

---

## üß™ –ö–ê–ö –¢–ï–°–¢–ò–†–û–í–ê–¢–¨ –ü–û–°–õ–ï –§–ò–ö–°–ê

### –¢–µ—Å—Ç 1: –û–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è –∑–¥–∞–Ω–∏—è
```bash
1. –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∫ –î–∏—Ä–µ–∫—Ç–æ—Ä/–ú–µ–Ω–µ–¥–∂–µ—Ä
2. –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:
   - –¢–∏–ø: –î–ª—è –∂–∏—Ç–µ–ª–µ–π
   - –¢–∞—Ä–≥–µ—Ç–∏–Ω–≥: –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–¥–∞–Ω–∏–µ
3. –û—Ç–∫—Ä—ã—Ç—å –≤—Ç–æ—Ä—É—é –≤–∫–ª–∞–¥–∫—É –∫–∞–∫ –∂–∏—Ç–µ–ª—å —ç—Ç–æ–≥–æ –∑–¥–∞–Ω–∏—è
4. ‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –í –¢–ï–ß–ï–ù–ò–ï 5 –°–ï–ö–£–ù–î (–±–µ–∑ refresh!)
5. –û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ—Ç—å—é –≤–∫–ª–∞–¥–∫—É –∫–∞–∫ –∂–∏—Ç–µ–ª—å –¥—Ä—É–≥–æ–≥–æ –∑–¥–∞–Ω–∏—è
6. ‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ù–ï –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è
```

### –¢–µ—Å—Ç 2: –û–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
```bash
1. –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∫ –î–∏—Ä–µ–∫—Ç–æ—Ä
2. –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:
   - –¢–∏–ø: –î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
3. –û—Ç–∫—Ä—ã—Ç—å –≤—Ç–æ—Ä—É—é –≤–∫–ª–∞–¥–∫—É –∫–∞–∫ executor (–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å)
4. ‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –í –¢–ï–ß–ï–ù–ò–ï 5 –°–ï–ö–£–ù–î
5. –û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ—Ç—å—é –≤–∫–ª–∞–¥–∫—É –∫–∞–∫ resident
6. ‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ù–ï –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è
```

### –¢–µ—Å—Ç 3: –°—Ä–æ—á–Ω–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö
```bash
1. –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∫ –î–∏—Ä–µ–∫—Ç–æ—Ä
2. –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:
   - –¢–∏–ø: –î–ª—è –∂–∏—Ç–µ–ª–µ–π
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–æ—á–Ω–æ–µ
   - –¢–∞—Ä–≥–µ—Ç–∏–Ω–≥: –í—Å–µ
3. ‚úÖ –í—Å–µ –∂–∏—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
4. ‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —É –≤—Å–µ—Ö –≤ real-time
```

---

## üìä IMPACT ASSESSMENT

### –ö—Ç–æ –∑–∞—Ç—Ä–æ–Ω—É—Ç —Å–µ–π—á–∞—Å:

| –†–æ–ª—å | –ü–æ–ª—É—á–∞—é—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è? | –ö–∞–∫ –ø–æ–ª—É—á–∞—é—Ç? |
|------|---------------------|---------------|
| **Director/Manager** | ‚úÖ –î–∞ | Real-time (WebSocket `announcements:all`) |
| **Residents** | ‚ùå –ù–ï–¢ | –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ manual refresh |
| **Executors** | ‚ùå –ù–ï–¢ | –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ manual refresh |

### –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞:

| –†–æ–ª—å | –ü–æ–ª—É—á–∞—é—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è? | –ö–∞–∫ –ø–æ–ª—É—á–∞—é—Ç? |
|------|---------------------|---------------|
| **Director/Manager** | ‚úÖ –î–∞ | Real-time (`announcements:all`) |
| **Residents** | ‚úÖ –î–∞ | Real-time (`announcements:building:X`) |
| **Executors** | ‚úÖ –î–∞ | Real-time (`announcements:all`) |

---

## üìù –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ù–ê–•–û–î–ö–ò

### 1. ‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**POST /api/announcements** (lines 2289-2381):
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å —Å `target_building_id`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ç–∞—Ä–≥–µ—Ç–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**GET /api/announcements** (lines 2191-2286):
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ `target_building_id`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∂–∏—Ç–µ–ª—è–º
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º

### 2. ‚úÖ Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**dataStore.ts addAnnouncement** (lines 1044-1093):
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `target_building_id` –≤ API
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ–∑–¥–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é
- ‚úÖ Fallback –Ω–∞ local-only –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**dataStore.ts getAnnouncementsForResidents** (lines 1165-1206):
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ building/entrance/floor
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç expiration
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç targeting

### 3. ‚ùå –¢–û–õ–¨–ö–û WebSocket (ConnectionManager) –±–∞–≥–æ–≤—ã–π

**–ë–∞–≥–∏ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤:**
- `ConnectionManager.ts:417` - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ `building_id`
- `ConnectionManager.ts:171-173` - –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è executors

---

## üöÄ –ü–†–ò–û–†–ò–¢–ï–¢ –§–ò–ö–°–ê

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ **CRITICAL**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
1. –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è 80% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. –ñ–∏—Ç–µ–ª–∏ –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ –≤–∏–¥—è—Ç —Å—Ä–æ—á–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
3. –ù–∞—Ä—É—à–µ–Ω–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –¥–µ–ª–∞—Ç—å manual refresh –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è —Ñ–∏–∫—Å–∞:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 —á–∞—Å–æ–≤)

---

## üìÇ –§–ê–ô–õ–´ –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø

1. **cloudflare/src/ConnectionManager.ts**
   - Line 173: –î–æ–±–∞–≤–∏—Ç—å `subs.add('announcements:all');` –¥–ª—è executors
   - Lines 417-421: –ó–∞–º–µ–Ω–∏—Ç—å `building_id` –Ω–∞ `target_building_id` (4 –º–µ—Å—Ç–∞)

**–í—Å–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:** 5 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è (simple string replacement)

**–†–∏—Å–∫:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π (—Ç–æ–ª—å–∫–æ —É–ª—É—á—à–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞)

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –±–∞–≥–∏:
1. ‚ùå **ConnectionManager –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ** (`building_id` –≤–º–µ—Å—Ç–æ `target_building_id`)
2. ‚ùå **Executors –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ announcements channel**

### –í–ª–∏—è–Ω–∏–µ:
- üî¥ –ñ–∏—Ç–µ–ª–∏ –ù–ï –ø–æ–ª—É—á–∞—é—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ real-time
- üî¥ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –ù–ï –ø–æ–ª—É—á–∞—é—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤–æ–æ–±—â–µ
- ‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä—ã/–ê–¥–º–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞—é—â–∞—è —Ä–æ–ª—å)

### –†–µ—à–µ–Ω–∏–µ:
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å 5 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –≤ ConnectionManager.ts
- ‚è±Ô∏è –í—Ä–µ–º—è —Ñ–∏–∫—Å–∞: ~30 –º–∏–Ω—É—Ç
- üéØ –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞: 100% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–ª—É—á–∞—é—Ç real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

---

**–ì–æ—Ç–æ–≤ –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é!**
*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é Claude Sonnet 4.5*
