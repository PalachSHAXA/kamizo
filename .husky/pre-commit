#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# ==================== TYPE CHECK ====================
echo "ğŸ“ Type checking..."
cd src/frontend
if ! npx tsc --noEmit; then
  echo "âŒ TypeScript type check failed"
  exit 1
fi
cd ../..
echo "âœ… Type check passed"

# ==================== BUILD CHECK ====================
echo "ğŸ”¨ Testing build..."
cd src/frontend
if ! npm run build > /dev/null 2>&1; then
  echo "âŒ Build failed"
  exit 1
fi
cd ../..
echo "âœ… Build successful"

# ==================== BUNDLE SIZE CHECK ====================
echo "ğŸ“¦ Checking bundle size..."
MAIN_SIZE=$(du -k src/frontend/dist/assets/index-*.js 2>/dev/null | cut -f1 | head -1 || echo "0")

if [ "$MAIN_SIZE" -gt 1024 ]; then
  echo "âš ï¸  Warning: Main bundle is ${MAIN_SIZE}KB (> 1MB)"
  echo "Consider code splitting or lazy loading"
fi
echo "âœ… Bundle size check complete"

# ==================== SECURITY CHECK ====================
echo "ğŸ”’ Checking for secrets..."
if git diff --cached | grep -iE "(api_key|apikey|password|secret|token|private_key).*=.*['\"]" | grep -v "node_modules"; then
  echo "âŒ Potential secrets detected in staged files"
  echo "Please remove sensitive data before committing"
  exit 1
fi
echo "âœ… No obvious secrets detected"

echo "âœ… All pre-commit checks passed!"
