{"version":3,"file":"ChatPage-1768934319777-BJir-1nX.js","sources":["../../src/pages/ChatPage.tsx"],"sourcesContent":["import { useState, useRef, useEffect, useCallback } from 'react';\r\nimport {\r\n  MessageCircle, Send, ArrowLeft, Users, Building2,\r\n  HeadphonesIcon, Search, Check, CheckCheck,\r\n  User, Crown, Shield, Wrench, Loader2, AlertCircle\r\n} from 'lucide-react';\r\nimport { useAuthStore } from '../stores/authStore';\r\nimport { useLanguageStore } from '../stores/languageStore';\r\nimport { chatApi } from '../services/api';\r\nimport { subscribeToChatMessages } from '../hooks/useWebSocketSync';\r\nimport { CHAT_CHANNEL_LABELS, type ChatChannelType, type UserRole } from '../types';\r\n\r\n// Types for API responses\r\ninterface ChatChannel {\r\n  id: string;\r\n  type: ChatChannelType;\r\n  name: string;\r\n  description?: string;\r\n  building_id?: string;\r\n  resident_id?: string;\r\n  message_count?: number;\r\n  last_message?: string;\r\n  last_message_at?: string;\r\n  last_sender_id?: string;\r\n  unread_count?: number;\r\n  created_at: string;\r\n}\r\n\r\ninterface ChatMessage {\r\n  id: string;\r\n  channel_id: string;\r\n  sender_id: string;\r\n  sender_name: string;\r\n  sender_role: UserRole;\r\n  content: string;\r\n  created_at: string;\r\n  read_by?: string[];\r\n}\r\n\r\n// Role badge component\r\nfunction RoleBadge({ role, language }: { role: UserRole; language: string }) {\r\n  const roleConfig: Record<UserRole, { label: string; labelUz: string; color: string; icon: React.ReactNode }> = {\r\n    admin: {\r\n      label: 'Админ',\r\n      labelUz: 'Admin',\r\n      color: 'bg-red-100 text-red-700',\r\n      icon: <Shield className=\"w-3 h-3\" />\r\n    },\r\n    manager: {\r\n      label: 'Менеджер',\r\n      labelUz: 'Menejer',\r\n      color: 'bg-purple-100 text-purple-700',\r\n      icon: <Crown className=\"w-3 h-3\" />\r\n    },\r\n    executor: {\r\n      label: 'Исполнитель',\r\n      labelUz: 'Ijrochi',\r\n      color: 'bg-orange-100 text-orange-700',\r\n      icon: <Wrench className=\"w-3 h-3\" />\r\n    },\r\n    resident: {\r\n      label: 'Житель',\r\n      labelUz: 'Turar joy egasi',\r\n      color: 'bg-blue-100 text-blue-700',\r\n      icon: <User className=\"w-3 h-3\" />\r\n    },\r\n    tenant: {\r\n      label: 'Арендатор',\r\n      labelUz: 'Ijarachi',\r\n      color: 'bg-green-100 text-green-700',\r\n      icon: <User className=\"w-3 h-3\" />\r\n    },\r\n    commercial_owner: {\r\n      label: 'Коммерция',\r\n      labelUz: 'Tijorat',\r\n      color: 'bg-yellow-100 text-yellow-700',\r\n      icon: <Building2 className=\"w-3 h-3\" />\r\n    },\r\n    department_head: {\r\n      label: 'Глава отдела',\r\n      labelUz: 'Bo\\'lim boshlig\\'i',\r\n      color: 'bg-indigo-100 text-indigo-700',\r\n      icon: <Crown className=\"w-3 h-3\" />\r\n    },\r\n    director: {\r\n      label: 'Директор',\r\n      labelUz: 'Direktor',\r\n      color: 'bg-rose-100 text-rose-700',\r\n      icon: <Crown className=\"w-3 h-3\" />\r\n    },\r\n    advertiser: {\r\n      label: 'Рекламодатель',\r\n      labelUz: 'Reklamaberuvchi',\r\n      color: 'bg-pink-100 text-pink-700',\r\n      icon: <User className=\"w-3 h-3\" />\r\n    },\r\n    coupon_checker: {\r\n      label: 'Чекер',\r\n      labelUz: 'Tekshiruvchi',\r\n      color: 'bg-teal-100 text-teal-700',\r\n      icon: <User className=\"w-3 h-3\" />\r\n    },\r\n    dispatcher: {\r\n      label: 'Диспетчер',\r\n      labelUz: 'Dispetcher',\r\n      color: 'bg-cyan-100 text-cyan-700',\r\n      icon: <User className=\"w-3 h-3\" />\r\n    },\r\n    security: {\r\n      label: 'Охранник',\r\n      labelUz: 'Qo\\'riqchi',\r\n      color: 'bg-slate-100 text-slate-700',\r\n      icon: <Shield className=\"w-3 h-3\" />\r\n    },\r\n    marketplace_manager: {\r\n      label: 'Менеджер магазина',\r\n      labelUz: 'Do\\'kon menejeri',\r\n      color: 'bg-emerald-100 text-emerald-700',\r\n      icon: <User className=\"w-3 h-3\" />\r\n    }\r\n  };\r\n\r\n  const config = roleConfig[role] || roleConfig.resident;\r\n\r\n  return (\r\n    <span className={`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium ${config.color}`}>\r\n      {config.icon}\r\n      {language === 'ru' ? config.label : config.labelUz}\r\n    </span>\r\n  );\r\n}\r\n\r\n// Channel list for admin/manager - shows private support chats from residents\r\nfunction AdminChannelList({\r\n  channels,\r\n  onSelectChannel,\r\n  selectedChannelId,\r\n  isLoading\r\n}: {\r\n  channels: ChatChannel[];\r\n  onSelectChannel: (channelId: string) => void;\r\n  selectedChannelId: string | null;\r\n  isLoading: boolean;\r\n}) {\r\n  const { language } = useLanguageStore();\r\n  const [searchQuery, setSearchQuery] = useState('');\r\n\r\n  // Filter channels by search query\r\n  const filteredChannels = channels.filter(ch => {\r\n    if (!searchQuery.trim()) return true;\r\n    const query = searchQuery.toLowerCase();\r\n    return (\r\n      ch.name?.toLowerCase().includes(query) ||\r\n      ch.description?.toLowerCase().includes(query) ||\r\n      ch.last_message?.toLowerCase().includes(query)\r\n    );\r\n  });\r\n\r\n  // Separate private support and group channels (from filtered)\r\n  // Sort by unread count (unread first), then by last_message_at\r\n  const sortByUnread = (a: ChatChannel, b: ChatChannel) => {\r\n    // First, sort by unread count (channels with unread messages first)\r\n    const aUnread = a.unread_count || 0;\r\n    const bUnread = b.unread_count || 0;\r\n    if (bUnread !== aUnread) return bUnread - aUnread;\r\n    // Then by last message time\r\n    const aTime = a.last_message_at ? new Date(a.last_message_at).getTime() : 0;\r\n    const bTime = b.last_message_at ? new Date(b.last_message_at).getTime() : 0;\r\n    return bTime - aTime;\r\n  };\r\n\r\n  const privateSupportChannels = filteredChannels\r\n    .filter(ch => ch.type === 'private_support')\r\n    .sort(sortByUnread);\r\n  const groupChannels = filteredChannels\r\n    .filter(ch => ch.type === 'uk_general' || ch.type === 'building_general')\r\n    .sort(sortByUnread);\r\n\r\n  // Calculate total unread\r\n  const totalUnread = channels.reduce((sum, ch) => sum + (ch.unread_count || 0), 0);\r\n\r\n  const getChannelIcon = (type: ChatChannelType) => {\r\n    switch (type) {\r\n      case 'uk_general': return <Building2 className=\"w-5 h-5\" />;\r\n      case 'building_general': return <Users className=\"w-5 h-5\" />;\r\n      case 'private_support': return <User className=\"w-5 h-5\" />;\r\n      default: return <MessageCircle className=\"w-5 h-5\" />;\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"h-full flex flex-col\">\r\n      {/* Header */}\r\n      <div className=\"p-4 border-b bg-white\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h2 className=\"text-lg font-bold\">\r\n              {language === 'ru' ? 'Сообщения' : 'Xabarlar'}\r\n            </h2>\r\n            <p className=\"text-sm text-gray-500 mt-1\">\r\n              {language === 'ru' ? 'Чаты с жителями и группы' : 'Aholi bilan chatlar va guruhlar'}\r\n            </p>\r\n          </div>\r\n          {totalUnread > 0 && (\r\n            <div className=\"flex items-center gap-2 px-3 py-1 bg-red-100 text-red-600 rounded-full\">\r\n              <span className=\"text-sm font-medium\">{totalUnread}</span>\r\n              <span className=\"text-xs\">{language === 'ru' ? 'новых' : 'yangi'}</span>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Search */}\r\n      <div className=\"p-3 border-b\">\r\n        <div className=\"relative\">\r\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400\" />\r\n          <input\r\n            type=\"text\"\r\n            value={searchQuery}\r\n            onChange={(e) => setSearchQuery(e.target.value)}\r\n            placeholder={language === 'ru' ? 'Поиск по имени или сообщению...' : 'Ism yoki xabar bo\\'yicha qidirish...'}\r\n            className=\"w-full pl-9 pr-4 py-2 bg-gray-100 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Channel list */}\r\n      <div className=\"flex-1 overflow-y-auto\">\r\n        {isLoading ? (\r\n          <div className=\"flex items-center justify-center py-8\">\r\n            <Loader2 className=\"w-6 h-6 animate-spin text-gray-400\" />\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* Private support chats section */}\r\n            {privateSupportChannels.length > 0 && (\r\n              <div>\r\n                <div className=\"px-4 py-2 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                  {language === 'ru' ? 'Обращения жителей' : 'Aholi murojatları'} ({privateSupportChannels.length})\r\n                </div>\r\n                <div className=\"divide-y\">\r\n                  {privateSupportChannels.map((channel) => {\r\n                    const isSelected = selectedChannelId === channel.id;\r\n\r\n                    return (\r\n                      <button\r\n                        key={channel.id}\r\n                        onClick={() => onSelectChannel(channel.id)}\r\n                        className={`w-full p-4 flex items-center gap-3 text-left hover:bg-gray-50 transition-colors ${\r\n                          isSelected ? 'bg-primary-50' : ''\r\n                        } ${channel.unread_count && channel.unread_count > 0 ? 'bg-blue-50/50' : ''}`}\r\n                      >\r\n                        <div className=\"relative\">\r\n                          <div className=\"w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-medium text-lg\">\r\n                            {/* Show first letter of name, fallback to 'U' for User if name is missing or starts with a number */}\r\n                            {channel.name && !/^\\d/.test(channel.name) ? channel.name.charAt(0).toUpperCase() : 'U'}\r\n                          </div>\r\n                          {channel.unread_count && channel.unread_count > 0 && (\r\n                            <div className=\"absolute -top-1 -right-1 min-w-5 h-5 bg-red-500 rounded-full flex items-center justify-center\">\r\n                              <span className=\"text-xs text-white font-medium px-1\">\r\n                                {channel.unread_count > 99 ? '99+' : channel.unread_count}\r\n                              </span>\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"flex-1 min-w-0\">\r\n                          <div className=\"flex items-center justify-between\">\r\n                            <span className={`truncate ${channel.unread_count && channel.unread_count > 0 ? 'font-semibold' : 'font-medium'}`}>\r\n                              {channel.name}\r\n                            </span>\r\n                            {channel.last_message_at && (\r\n                              <span className={`text-xs ${channel.unread_count && channel.unread_count > 0 ? 'text-blue-500 font-medium' : 'text-gray-400'}`}>\r\n                                {new Date(channel.last_message_at).toLocaleTimeString(language === 'ru' ? 'ru-RU' : 'uz-UZ', {\r\n                                  hour: '2-digit',\r\n                                  minute: '2-digit'\r\n                                })}\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n                          <div className=\"flex items-center gap-2\">\r\n                            {channel.description && (\r\n                              <span className=\"text-xs text-gray-400\">\r\n                                {channel.description}\r\n                              </span>\r\n                            )}\r\n                            <span className={`text-sm truncate ${channel.unread_count && channel.unread_count > 0 ? 'text-gray-700 font-medium' : 'text-gray-500'}`}>\r\n                              {channel.last_message || ''}\r\n                            </span>\r\n                          </div>\r\n                        </div>\r\n                      </button>\r\n                    );\r\n                  })}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Group channels section */}\r\n            <div>\r\n              <div className=\"px-4 py-2 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                {language === 'ru' ? 'Групповые чаты' : 'Guruh chatlari'}\r\n              </div>\r\n              <div className=\"divide-y\">\r\n                {groupChannels.map((channel) => {\r\n                  const labels = CHAT_CHANNEL_LABELS[channel.type];\r\n                  const isSelected = selectedChannelId === channel.id;\r\n\r\n                  return (\r\n                    <button\r\n                      key={channel.id}\r\n                      onClick={() => onSelectChannel(channel.id)}\r\n                      className={`w-full p-4 flex items-center gap-3 text-left hover:bg-gray-50 transition-colors ${\r\n                        isSelected ? 'bg-primary-50' : ''\r\n                      }`}\r\n                    >\r\n                      <div className={`w-12 h-12 rounded-full flex items-center justify-center ${\r\n                        channel.type === 'uk_general' ? 'bg-purple-100 text-purple-600' : 'bg-green-100 text-green-600'\r\n                      }`}>\r\n                        {getChannelIcon(channel.type)}\r\n                      </div>\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                          <span className=\"font-medium truncate\">\r\n                            {language === 'ru' ? labels.label : labels.labelUz}\r\n                          </span>\r\n                          {channel.last_message_at && (\r\n                            <span className=\"text-xs text-gray-400\">\r\n                              {new Date(channel.last_message_at).toLocaleTimeString(language === 'ru' ? 'ru-RU' : 'uz-UZ', {\r\n                                hour: '2-digit',\r\n                                minute: '2-digit'\r\n                              })}\r\n                            </span>\r\n                          )}\r\n                        </div>\r\n                        {channel.message_count && channel.message_count > 0 ? (\r\n                          <div className=\"flex items-center gap-2 text-sm text-gray-500\">\r\n                            <Users className=\"w-3.5 h-3.5\" />\r\n                            <span>{channel.message_count} {language === 'ru' ? 'сообщений' : 'xabar'}</span>\r\n                          </div>\r\n                        ) : (\r\n                          <p className=\"text-sm text-gray-400\">\r\n                            {language === 'ru' ? 'Нет сообщений' : 'Xabar yo\\'q'}\r\n                          </p>\r\n                        )}\r\n                      </div>\r\n                    </button>\r\n                  );\r\n                })}\r\n              </div>\r\n            </div>\r\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// Chat view component - shared for all users\r\nfunction ChatView({\r\n  channelId,\r\n  channel,\r\n  onBack,\r\n  hideBackOnDesktop = false\r\n}: {\r\n  channelId: string;\r\n  channel?: ChatChannel;\r\n  onBack: () => void;\r\n  hideBackOnDesktop?: boolean;\r\n}) {\r\n  const { user } = useAuthStore();\r\n  const { language } = useLanguageStore();\r\n\r\n  const [messages, setMessages] = useState<ChatMessage[]>([]);\r\n  const [newMessage, setNewMessage] = useState('');\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isSending, setIsSending] = useState(false);\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Fetch messages\r\n  const fetchMessages = useCallback(async () => {\r\n    // Skip if channelId is not valid\r\n    if (!channelId || channelId === 'undefined') {\r\n      console.warn('Invalid channelId, skipping message fetch');\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n    try {\r\n      const response = await chatApi.getMessages(channelId);\r\n      const messageList = response.messages || [];\r\n      setMessages(messageList);\r\n    } catch (error) {\r\n      console.error('Failed to fetch messages:', error);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [channelId]);\r\n\r\n  // Mark channel as read when opening\r\n  const markAsRead = useCallback(async () => {\r\n    if (!channelId || channelId === 'undefined') return;\r\n    try {\r\n      await chatApi.markRead(channelId);\r\n    } catch (error) {\r\n      console.error('Failed to mark as read:', error);\r\n    }\r\n  }, [channelId]);\r\n\r\n  // Initial fetch and WebSocket subscription (no polling!)\r\n  useEffect(() => {\r\n    setIsLoading(true);\r\n    fetchMessages();\r\n\r\n    // Mark channel as read when opening\r\n    markAsRead();\r\n\r\n    // Subscribe to WebSocket chat messages instead of polling\r\n    const unsubscribe = subscribeToChatMessages((message) => {\r\n      // Only process messages for this channel\r\n      if (message.channel_id === channelId) {\r\n        console.log('[Chat] WebSocket message for this channel:', message);\r\n\r\n        // Handle read receipts\r\n        if (message.type === 'read') {\r\n          setMessages(prev => prev.map(m =>\r\n            m.id === message.message_id\r\n              ? { ...m, read_by: [...(m.read_by || []), message.user_id] }\r\n              : m\r\n          ));\r\n          return;\r\n        }\r\n\r\n        // Add new message if not already present\r\n        setMessages(prev => {\r\n          const exists = prev.some(m => m.id === message.id);\r\n          if (exists) return prev;\r\n          return [...prev, message];\r\n        });\r\n\r\n        // Auto-mark new messages as read since user is viewing\r\n        markAsRead();\r\n      }\r\n    });\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [fetchMessages, channelId, markAsRead]);\r\n\r\n  // Scroll to bottom on new messages - with slight delay to ensure DOM update\r\n  useEffect(() => {\r\n    const timer = setTimeout(() => {\r\n      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n    }, 100);\r\n    return () => clearTimeout(timer);\r\n  }, [messages.length]);\r\n\r\n  const handleSend = async () => {\r\n    if (!newMessage.trim() || !user || isSending) return;\r\n\r\n    const messageToSend = newMessage.trim();\r\n    setNewMessage(''); // Clear immediately for better UX\r\n    setIsSending(true);\r\n\r\n    try {\r\n      const response = await chatApi.sendMessage(channelId, messageToSend);\r\n      // Add sent message to local state immediately (optimistic update)\r\n      if (response.message) {\r\n        setMessages(prev => {\r\n          const exists = prev.some(m => m.id === response.message.id);\r\n          if (exists) return prev;\r\n          return [...prev, response.message];\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to send message:', error);\r\n      // Restore message on error\r\n      setNewMessage(messageToSend);\r\n      alert('Не удалось отправить сообщение');\r\n    } finally {\r\n      setIsSending(false);\r\n    }\r\n  };\r\n\r\n  // Get channel title based on type\r\n  const getChannelTitle = () => {\r\n    if (channel?.type === 'private_support') {\r\n      // For residents - show \"Chat with administration\"\r\n      if (user?.role === 'resident') {\r\n        return language === 'ru' ? 'Чат с администрацией' : 'Administratsiya bilan chat';\r\n      }\r\n      // For admin/manager - show resident name\r\n      return channel.name || 'Чат';\r\n    }\r\n    if (channel) {\r\n      const labels = CHAT_CHANNEL_LABELS[channel.type];\r\n      return language === 'ru' ? labels.label : labels.labelUz;\r\n    }\r\n    return language === 'ru' ? 'Чат' : 'Chat';\r\n  };\r\n\r\n  const getChannelSubtitle = () => {\r\n    if (channel?.type === 'private_support') {\r\n      if (user?.role === 'resident') {\r\n        return language === 'ru' ? 'Личный чат' : 'Shaxsiy chat';\r\n      }\r\n      return channel.description || '';\r\n    }\r\n    return `${messages.length} ${language === 'ru' ? 'сообщений' : 'xabar'}`;\r\n  };\r\n\r\n  const isResidentView = user?.role === 'resident' && channel?.type === 'private_support';\r\n\r\n  return (\r\n    <div className=\"h-full flex flex-col bg-gray-50\">\r\n      {/* Header - compact for residents */}\r\n      <div className={`bg-white border-b flex items-center gap-3 ${isResidentView ? 'p-3' : 'p-4'}`}>\r\n        {!hideBackOnDesktop && (\r\n          <button\r\n            onClick={onBack}\r\n            className=\"p-2 hover:bg-gray-100 rounded-xl md:hidden\"\r\n          >\r\n            <ArrowLeft className=\"w-5 h-5\" />\r\n          </button>\r\n        )}\r\n        <div className={`rounded-full flex items-center justify-center ${\r\n          isResidentView ? 'w-8 h-8' : 'w-10 h-10'\r\n        } ${\r\n          channel?.type === 'private_support' ? 'bg-blue-100 text-blue-600' :\r\n          channel?.type === 'uk_general' ? 'bg-purple-100 text-purple-600' :\r\n          channel?.type === 'building_general' ? 'bg-green-100 text-green-600' :\r\n          channel?.type === 'entrance' ? 'bg-amber-100 text-amber-600' :\r\n          'bg-gray-100 text-gray-600'\r\n        }`}>\r\n          {channel?.type === 'private_support' ? (\r\n            user?.role === 'resident' ? <HeadphonesIcon className={isResidentView ? 'w-4 h-4' : 'w-5 h-5'} /> : <User className=\"w-5 h-5\" />\r\n          ) : (\r\n            <MessageCircle className=\"w-5 h-5\" />\r\n          )}\r\n        </div>\r\n        <div className=\"flex-1\">\r\n          <h3 className={`font-medium ${isResidentView ? 'text-sm' : ''}`}>{getChannelTitle()}</h3>\r\n          {!isResidentView && <p className=\"text-xs text-gray-500\">{getChannelSubtitle()}</p>}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Messages */}\r\n      <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\r\n        {isLoading ? (\r\n          <div className=\"h-full flex items-center justify-center\">\r\n            <Loader2 className=\"w-8 h-8 animate-spin text-gray-400\" />\r\n          </div>\r\n        ) : messages.length === 0 ? (\r\n          <div className=\"h-full flex flex-col items-center justify-center text-center\">\r\n            <HeadphonesIcon className=\"w-10 h-10 text-gray-300 mb-3\" />\r\n            <p className=\"text-gray-400 text-sm\">\r\n              {language === 'ru' ? 'Напишите ваш вопрос' : 'Savolingizni yozing'}\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {messages.map((message, index) => {\r\n              const isOwn = message.sender_id === user?.id;\r\n              const showAvatar = index === 0 ||\r\n                messages[index - 1].sender_id !== message.sender_id;\r\n              const showName = !isOwn && showAvatar;\r\n\r\n              return (\r\n                <div\r\n                  key={message.id}\r\n                  className={`flex ${isOwn ? 'justify-end' : 'justify-start'}`}\r\n                >\r\n                  <div className={`max-w-[80%] ${isOwn ? 'order-1' : ''}`}>\r\n                    {showName && (\r\n                      <div className=\"flex items-center gap-2 mb-1 px-2\">\r\n                        <span className=\"text-sm font-medium text-gray-700\">\r\n                          {message.sender_name}\r\n                        </span>\r\n                        <RoleBadge role={message.sender_role} language={language} />\r\n                      </div>\r\n                    )}\r\n                    <div className={`px-4 py-2 rounded-2xl ${\r\n                      isOwn\r\n                        ? 'bg-primary-500 text-gray-900 rounded-br-md'\r\n                        : 'bg-white text-gray-900 rounded-bl-md shadow-sm'\r\n                    }`}>\r\n                      <p className=\"text-sm whitespace-pre-wrap\">{message.content}</p>\r\n                      <div className={`flex items-center justify-end gap-1 mt-1 ${\r\n                        isOwn ? 'text-gray-700' : 'text-gray-400'\r\n                      }`}>\r\n                        <span className=\"text-[10px]\">\r\n                          {new Date(message.created_at).toLocaleTimeString(language === 'ru' ? 'ru-RU' : 'uz-UZ', {\r\n                            hour: '2-digit',\r\n                            minute: '2-digit'\r\n                          })}\r\n                        </span>\r\n                        {isOwn && (\r\n                          message.read_by && message.read_by.length > 1\r\n                            ? <CheckCheck className=\"w-3 h-3\" />\r\n                            : <Check className=\"w-3 h-3\" />\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              );\r\n            })}\r\n            <div ref={messagesEndRef} />\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {/* Input */}\r\n      <div className={`bg-white border-t ${isResidentView ? 'p-3' : 'p-4'}`}>\r\n        <div className=\"flex items-center gap-2\">\r\n          <input\r\n            type=\"text\"\r\n            value={newMessage}\r\n            onChange={(e) => setNewMessage(e.target.value)}\r\n            onKeyDown={(e) => {\r\n              if (e.key === 'Enter' && !e.shiftKey) {\r\n                e.preventDefault();\r\n                handleSend();\r\n              }\r\n            }}\r\n            placeholder={language === 'ru' ? 'Написать...' : 'Yozing...'}\r\n            className={`flex-1 bg-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 ${\r\n              isResidentView ? 'px-3 py-2.5 text-sm' : 'px-4 py-3'\r\n            }`}\r\n            disabled={isSending}\r\n          />\r\n          <button\r\n            onClick={handleSend}\r\n            disabled={!newMessage.trim() || isSending}\r\n            className={`bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 rounded-xl transition-colors ${\r\n              isResidentView ? 'p-2.5' : 'p-3'\r\n            }`}\r\n          >\r\n            {isSending ? (\r\n              <Loader2 className={`text-gray-900 animate-spin ${isResidentView ? 'w-4 h-4' : 'w-5 h-5'}`} />\r\n            ) : (\r\n              <Send className={`text-gray-900 ${isResidentView ? 'w-4 h-4' : 'w-5 h-5'}`} />\r\n            )}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// Sound notification hook\r\nfunction useNotificationSound() {\r\n  const audioRef = useRef<HTMLAudioElement | null>(null);\r\n\r\n  useEffect(() => {\r\n    // Create audio element for notification sound\r\n    audioRef.current = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU' + btoa(String.fromCharCode.apply(null, Array(1000).fill(128).map((_, i) => Math.sin(i * 0.1) * 50 + 128))));\r\n    audioRef.current.volume = 0.3;\r\n  }, []);\r\n\r\n  const playSound = useCallback(() => {\r\n    if (audioRef.current) {\r\n      audioRef.current.currentTime = 0;\r\n      audioRef.current.play().catch(() => {});\r\n    }\r\n  }, []);\r\n\r\n  return playSound;\r\n}\r\n\r\n// Main Chat Page\r\nexport function ChatPage() {\r\n  const { user } = useAuthStore();\r\n  const { language } = useLanguageStore();\r\n  const [channels, setChannels] = useState<ChatChannel[]>([]);\r\n  const [selectedChannelId, setSelectedChannelId] = useState<string | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [residentChannel, setResidentChannel] = useState<ChatChannel | null>(null);\r\n  const prevUnreadRef = useRef<number>(0);\r\n  const playSound = useNotificationSound();\r\n\r\n  const isResident = user?.role === 'resident';\r\n\r\n  // Fetch channels with polling\r\n  const fetchChannels = useCallback(async () => {\r\n    try {\r\n      setError(null);\r\n      if (isResident) {\r\n        const channel = await chatApi.getOrCreateSupportChannel();\r\n        if (channel && channel.id) {\r\n          setResidentChannel(channel);\r\n        } else {\r\n          setError(language === 'ru' ? 'Не удалось создать чат' : 'Chat yaratib bo\\'lmadi');\r\n        }\r\n      } else {\r\n        const response = await chatApi.getChannels();\r\n        const newChannels = response.channels || [];\r\n\r\n        // Calculate total unread\r\n        const totalUnread = newChannels.reduce((sum: number, ch: ChatChannel) => sum + (ch.unread_count || 0), 0);\r\n\r\n        // Play sound if new messages arrived\r\n        if (totalUnread > prevUnreadRef.current && prevUnreadRef.current > 0) {\r\n          playSound();\r\n        }\r\n        prevUnreadRef.current = totalUnread;\r\n\r\n        setChannels(newChannels);\r\n      }\r\n    } catch (err) {\r\n      console.error('Failed to fetch channels:', err);\r\n      setError(language === 'ru' ? 'Ошибка загрузки' : 'Yuklanmadi');\r\n    }\r\n  }, [isResident, playSound, language]);\r\n\r\n  // Initial fetch\r\n  useEffect(() => {\r\n    setIsLoading(true);\r\n    fetchChannels().finally(() => setIsLoading(false));\r\n  }, [fetchChannels]);\r\n\r\n  // Poll for channel updates every 5 seconds\r\n  useEffect(() => {\r\n    if (isResident) return;\r\n\r\n    const interval = setInterval(fetchChannels, 5000);\r\n    return () => clearInterval(interval);\r\n  }, [fetchChannels, isResident]);\r\n\r\n  // Find selected channel\r\n  const selectedChannel = channels.find(ch => ch.id === selectedChannelId);\r\n\r\n  // If resident and has channel, show compact chat card\r\n  if (isResident) {\r\n    if (isLoading) {\r\n      return (\r\n        <div className=\"max-w-lg mx-auto\">\r\n          <div className=\"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex items-center justify-center\">\r\n            <Loader2 className=\"w-8 h-8 animate-spin text-gray-400\" />\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    if (residentChannel) {\r\n      return (\r\n        <div className=\"max-w-lg mx-auto\">\r\n          <div className=\"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex flex-col\">\r\n            <ChatView\r\n              channelId={residentChannel.id}\r\n              channel={residentChannel}\r\n              onBack={() => window.history.back()}\r\n              hideBackOnDesktop\r\n            />\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <div className=\"max-w-lg mx-auto\">\r\n        <div className=\"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex flex-col items-center justify-center gap-4 p-6\">\r\n          <AlertCircle className=\"w-12 h-12 text-red-400\" />\r\n          <p className=\"text-gray-500 text-center\">{error || (language === 'ru' ? 'Ошибка загрузки чата' : 'Chat yuklanmadi')}</p>\r\n          <button\r\n            onClick={() => {\r\n              setIsLoading(true);\r\n              setError(null);\r\n              fetchChannels().finally(() => setIsLoading(false));\r\n            }}\r\n            className=\"px-4 py-2 bg-primary-500 text-gray-900 rounded-xl hover:bg-primary-600 transition-colors\"\r\n          >\r\n            {language === 'ru' ? 'Повторить' : 'Qayta urinish'}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // For admin/manager - show channel list with chat view\r\n  return (\r\n    <div className=\"h-[calc(100vh-180px)] md:h-[calc(100vh-140px)] bg-white rounded-2xl shadow-sm border overflow-hidden\">\r\n      <div className=\"h-full flex\">\r\n        {/* Channel list - always visible on desktop, hidden when chat selected on mobile */}\r\n        <div className={`${\r\n          selectedChannelId ? 'hidden md:block' : 'block'\r\n        } w-full md:w-80 lg:w-96 border-r bg-white/80 backdrop-blur-sm`}>\r\n          <AdminChannelList\r\n            channels={channels}\r\n            onSelectChannel={setSelectedChannelId}\r\n            selectedChannelId={selectedChannelId}\r\n            isLoading={isLoading}\r\n          />\r\n        </div>\r\n\r\n        {/* Chat view - shown when channel selected */}\r\n        <div className={`${\r\n          selectedChannelId ? 'block' : 'hidden md:flex'\r\n        } flex-1 bg-gray-50/50`}>\r\n          {selectedChannelId ? (\r\n            <ChatView\r\n              channelId={selectedChannelId}\r\n              channel={selectedChannel}\r\n              onBack={() => setSelectedChannelId(null)}\r\n            />\r\n          ) : (\r\n            <div className=\"h-full flex items-center justify-center\">\r\n              <div className=\"text-center\">\r\n                <div className=\"w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center\">\r\n                  <MessageCircle className=\"w-10 h-10 text-gray-400\" />\r\n                </div>\r\n                <p className=\"text-gray-500\">\r\n                  {language === 'ru' ? 'Выберите чат для просмотра' : 'Ko\\'rish uchun chatni tanlang'}\r\n                </p>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":["RoleBadge","role","language","roleConfig","jsx","Shield","Crown","Wrench","User","Building2","config","AdminChannelList","channels","onSelectChannel","selectedChannelId","isLoading","useLanguageStore","searchQuery","setSearchQuery","useState","filteredChannels","ch","query","sortByUnread","a","b","aUnread","bUnread","aTime","privateSupportChannels","groupChannels","totalUnread","sum","getChannelIcon","type","Users","MessageCircle","jsxs","Search","e","Loader2","Fragment","channel","isSelected","labels","CHAT_CHANNEL_LABELS","ChatView","channelId","onBack","hideBackOnDesktop","user","useAuthStore","messages","setMessages","newMessage","setNewMessage","setIsLoading","isSending","setIsSending","messagesEndRef","useRef","fetchMessages","useCallback","messageList","chatApi","markAsRead","useEffect","unsubscribe","subscribeToChatMessages","message","prev","m","timer","handleSend","messageToSend","response","getChannelTitle","getChannelSubtitle","isResidentView","ArrowLeft","HeadphonesIcon","index","isOwn","showAvatar","showName","CheckCheck","Check","Send","useNotificationSound","audioRef","_","i","ChatPage","setChannels","setSelectedChannelId","error","setError","residentChannel","setResidentChannel","prevUnreadRef","playSound","isResident","fetchChannels","newChannels","interval","selectedChannel","AlertCircle"],"mappings":"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"}