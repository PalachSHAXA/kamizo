import{r as n,j as e,$,O as q,k as L,aA as F,a$ as R,U as _,b0 as I,a2 as O,ao as V,z as G,h as E,B as M,o as B,a5 as z,W as H}from"./react-vendor-1768936274458-rd3wd0Us.js";import{b as Q,d as T,z as A,C as K,E as Z}from"./index-1768936274458-DQj4Cu1o.js";import"./vendor-1768936274458-BnsfpFWz.js";import"./qr-scanner-1768936274458-cr32YHjo.js";import"./zustand-1768936274458-wNUYBKDB.js";function X({role:l,language:a}){const f={admin:{label:"Админ",labelUz:"Admin",color:"bg-red-100 text-red-700",icon:e.jsx(B,{className:"w-3 h-3"})},manager:{label:"Менеджер",labelUz:"Menejer",color:"bg-purple-100 text-purple-700",icon:e.jsx(z,{className:"w-3 h-3"})},executor:{label:"Исполнитель",labelUz:"Ijrochi",color:"bg-orange-100 text-orange-700",icon:e.jsx(H,{className:"w-3 h-3"})},resident:{label:"Житель",labelUz:"Turar joy egasi",color:"bg-blue-100 text-blue-700",icon:e.jsx(_,{className:"w-3 h-3"})},tenant:{label:"Арендатор",labelUz:"Ijarachi",color:"bg-green-100 text-green-700",icon:e.jsx(_,{className:"w-3 h-3"})},commercial_owner:{label:"Коммерция",labelUz:"Tijorat",color:"bg-yellow-100 text-yellow-700",icon:e.jsx(M,{className:"w-3 h-3"})},department_head:{label:"Глава отдела",labelUz:"Bo'lim boshlig'i",color:"bg-indigo-100 text-indigo-700",icon:e.jsx(z,{className:"w-3 h-3"})},director:{label:"Директор",labelUz:"Direktor",color:"bg-rose-100 text-rose-700",icon:e.jsx(z,{className:"w-3 h-3"})},advertiser:{label:"Рекламодатель",labelUz:"Reklamaberuvchi",color:"bg-pink-100 text-pink-700",icon:e.jsx(_,{className:"w-3 h-3"})},coupon_checker:{label:"Чекер",labelUz:"Tekshiruvchi",color:"bg-teal-100 text-teal-700",icon:e.jsx(_,{className:"w-3 h-3"})},dispatcher:{label:"Диспетчер",labelUz:"Dispetcher",color:"bg-cyan-100 text-cyan-700",icon:e.jsx(_,{className:"w-3 h-3"})},security:{label:"Охранник",labelUz:"Qo'riqchi",color:"bg-slate-100 text-slate-700",icon:e.jsx(B,{className:"w-3 h-3"})},marketplace_manager:{label:"Менеджер магазина",labelUz:"Do'kon menejeri",color:"bg-emerald-100 text-emerald-700",icon:e.jsx(_,{className:"w-3 h-3"})}},m=f[l]||f.resident;return e.jsxs("span",{className:`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium ${m.color}`,children:[m.icon,a==="ru"?m.label:m.labelUz]})}function Y({channels:l,onSelectChannel:a,selectedChannelId:f,isLoading:m}){const{language:r}=T(),[c,b]=n.useState(""),h=l.filter(s=>{if(!c.trim())return!0;const i=c.toLowerCase();return s.name?.toLowerCase().includes(i)||s.description?.toLowerCase().includes(i)||s.last_message?.toLowerCase().includes(i)}),y=(s,i)=>{const x=s.unread_count||0,N=i.unread_count||0;if(N!==x)return N-x;const u=s.last_message_at?new Date(s.last_message_at).getTime():0;return(i.last_message_at?new Date(i.last_message_at).getTime():0)-u},g=h.filter(s=>s.type==="private_support").sort(y),C=h.filter(s=>s.type==="uk_general"||s.type==="building_general").sort(y),w=l.reduce((s,i)=>s+(i.unread_count||0),0),j=s=>{switch(s){case"uk_general":return e.jsx(M,{className:"w-5 h-5"});case"building_general":return e.jsx(E,{className:"w-5 h-5"});case"private_support":return e.jsx(_,{className:"w-5 h-5"});default:return e.jsx(L,{className:"w-5 h-5"})}};return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"p-4 border-b bg-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold",children:r==="ru"?"Сообщения":"Xabarlar"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:r==="ru"?"Чаты с жителями и группы":"Aholi bilan chatlar va guruhlar"})]}),w>0&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-red-100 text-red-600 rounded-full",children:[e.jsx("span",{className:"text-sm font-medium",children:w}),e.jsx("span",{className:"text-xs",children:r==="ru"?"новых":"yangi"})]})]})}),e.jsx("div",{className:"p-3 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx(G,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",value:c,onChange:s=>b(s.target.value),placeholder:r==="ru"?"Поиск по имени или сообщению...":"Ism yoki xabar bo'yicha qidirish...",className:"w-full pl-9 pr-4 py-2 bg-gray-100 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:m?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx($,{className:"w-6 h-6 animate-spin text-gray-400"})}):e.jsxs(e.Fragment,{children:[g.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"px-4 py-2 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider",children:[r==="ru"?"Обращения жителей":"Aholi murojatları"," (",g.length,")"]}),e.jsx("div",{className:"divide-y",children:g.map(s=>{const i=f===s.id;return e.jsxs("button",{onClick:()=>a(s.id),className:`w-full p-4 flex items-center gap-3 text-left hover:bg-gray-50 transition-colors ${i?"bg-primary-50":""} ${s.unread_count&&s.unread_count>0?"bg-blue-50/50":""}`,children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-medium text-lg",children:s.name&&!/^\d/.test(s.name)?s.name.charAt(0).toUpperCase():"U"}),s.unread_count&&s.unread_count>0&&e.jsx("div",{className:"absolute -top-1 -right-1 min-w-5 h-5 bg-red-500 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-white font-medium px-1",children:s.unread_count>99?"99+":s.unread_count})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`truncate ${s.unread_count&&s.unread_count>0?"font-semibold":"font-medium"}`,children:s.name}),s.last_message_at&&e.jsx("span",{className:`text-xs ${s.unread_count&&s.unread_count>0?"text-blue-500 font-medium":"text-gray-400"}`,children:new Date(s.last_message_at).toLocaleTimeString(r==="ru"?"ru-RU":"uz-UZ",{hour:"2-digit",minute:"2-digit"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.description&&e.jsx("span",{className:"text-xs text-gray-400",children:s.description}),e.jsx("span",{className:`text-sm truncate ${s.unread_count&&s.unread_count>0?"text-gray-700 font-medium":"text-gray-500"}`,children:s.last_message||""})]})]})]},s.id)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"px-4 py-2 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider",children:r==="ru"?"Групповые чаты":"Guruh chatlari"}),e.jsx("div",{className:"divide-y",children:C.map(s=>{const i=Z[s.type],x=f===s.id;return e.jsxs("button",{onClick:()=>a(s.id),className:`w-full p-4 flex items-center gap-3 text-left hover:bg-gray-50 transition-colors ${x?"bg-primary-50":""}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${s.type==="uk_general"?"bg-purple-100 text-purple-600":"bg-green-100 text-green-600"}`,children:j(s.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium truncate",children:r==="ru"?i.label:i.labelUz}),s.last_message_at&&e.jsx("span",{className:"text-xs text-gray-400",children:new Date(s.last_message_at).toLocaleTimeString(r==="ru"?"ru-RU":"uz-UZ",{hour:"2-digit",minute:"2-digit"})})]}),s.message_count&&s.message_count>0?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(E,{className:"w-3.5 h-3.5"}),e.jsxs("span",{children:[s.message_count," ",r==="ru"?"сообщений":"xabar"]})]}):e.jsx("p",{className:"text-sm text-gray-400",children:r==="ru"?"Нет сообщений":"Xabar yo'q"})]})]},s.id)})})]})]})})]})}function D({channelId:l,channel:a,onBack:f,hideBackOnDesktop:m=!1}){const{user:r}=Q(),{language:c}=T(),[b,h]=n.useState([]),[y,g]=n.useState(""),[C,w]=n.useState(!0),[j,s]=n.useState(!1),i=n.useRef(null),x=n.useCallback(async()=>{if(!l||l==="undefined"){w(!1);return}try{const o=(await A.getMessages(l)).messages||[];h(o)}catch{}finally{w(!1)}},[l]),N=n.useCallback(async()=>{if(!(!l||l==="undefined"))try{await A.markRead(l)}catch{}},[l]);n.useEffect(()=>{w(!0),x(),N();const t=K(o=>{if(o.channel_id===l){if(o.type==="read"){h(d=>d.map(v=>v.id===o.message_id?{...v,read_by:[...v.read_by||[],o.user_id]}:v));return}h(d=>d.some(S=>S.id===o.id)?d:[...d,o]),N()}});return()=>{t()}},[x,l,N]),n.useEffect(()=>{const t=setTimeout(()=>{i.current?.scrollIntoView({behavior:"smooth"})},100);return()=>clearTimeout(t)},[b.length]);const u=async()=>{if(!y.trim()||!r||j)return;const t=y.trim();g(""),s(!0);try{const o=await A.sendMessage(l,t);o.message&&h(d=>d.some(S=>S.id===o.message.id)?d:[...d,o.message])}catch{g(t),alert("Не удалось отправить сообщение")}finally{s(!1)}},k=()=>{if(a?.type==="private_support")return r?.role==="resident"?c==="ru"?"Чат с администрацией":"Administratsiya bilan chat":a.name||"Чат";if(a){const t=Z[a.type];return c==="ru"?t.label:t.labelUz}return c==="ru"?"Чат":"Chat"},U=()=>a?.type==="private_support"?r?.role==="resident"?c==="ru"?"Личный чат":"Shaxsiy chat":a.description||"":`${b.length} ${c==="ru"?"сообщений":"xabar"}`,p=r?.role==="resident"&&a?.type==="private_support";return e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsxs("div",{className:`bg-white border-b flex items-center gap-3 ${p?"p-3":"p-4"}`,children:[!m&&e.jsx("button",{onClick:f,className:"p-2 hover:bg-gray-100 rounded-xl md:hidden",children:e.jsx(F,{className:"w-5 h-5"})}),e.jsx("div",{className:`rounded-full flex items-center justify-center ${p?"w-8 h-8":"w-10 h-10"} ${a?.type==="private_support"?"bg-blue-100 text-blue-600":a?.type==="uk_general"?"bg-purple-100 text-purple-600":a?.type==="building_general"?"bg-green-100 text-green-600":a?.type==="entrance"?"bg-amber-100 text-amber-600":"bg-gray-100 text-gray-600"}`,children:a?.type==="private_support"?r?.role==="resident"?e.jsx(R,{className:p?"w-4 h-4":"w-5 h-5"}):e.jsx(_,{className:"w-5 h-5"}):e.jsx(L,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:`font-medium ${p?"text-sm":""}`,children:k()}),!p&&e.jsx("p",{className:"text-xs text-gray-500",children:U()})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:C?e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsx($,{className:"w-8 h-8 animate-spin text-gray-400"})}):b.length===0?e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-center",children:[e.jsx(R,{className:"w-10 h-10 text-gray-300 mb-3"}),e.jsx("p",{className:"text-gray-400 text-sm",children:c==="ru"?"Напишите ваш вопрос":"Savolingizni yozing"})]}):e.jsxs(e.Fragment,{children:[b.map((t,o)=>{const d=t.sender_id===r?.id,v=o===0||b[o-1].sender_id!==t.sender_id,S=!d&&v;return e.jsx("div",{className:`flex ${d?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[80%] ${d?"order-1":""}`,children:[S&&e.jsxs("div",{className:"flex items-center gap-2 mb-1 px-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:t.sender_name}),e.jsx(X,{role:t.sender_role,language:c})]}),e.jsxs("div",{className:`px-4 py-2 rounded-2xl ${d?"bg-primary-500 text-gray-900 rounded-br-md":"bg-white text-gray-900 rounded-bl-md shadow-sm"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.content}),e.jsxs("div",{className:`flex items-center justify-end gap-1 mt-1 ${d?"text-gray-700":"text-gray-400"}`,children:[e.jsx("span",{className:"text-[10px]",children:new Date(t.created_at).toLocaleTimeString(c==="ru"?"ru-RU":"uz-UZ",{hour:"2-digit",minute:"2-digit"})}),d&&(t.read_by&&t.read_by.length>1?e.jsx(I,{className:"w-3 h-3"}):e.jsx(O,{className:"w-3 h-3"}))]})]})]})},t.id)}),e.jsx("div",{ref:i})]})}),e.jsx("div",{className:`bg-white border-t ${p?"p-3":"p-4"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:y,onChange:t=>g(t.target.value),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),u())},placeholder:c==="ru"?"Написать...":"Yozing...",className:`flex-1 bg-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 ${p?"px-3 py-2.5 text-sm":"px-4 py-3"}`,disabled:j}),e.jsx("button",{onClick:u,disabled:!y.trim()||j,className:`bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 rounded-xl transition-colors ${p?"p-2.5":"p-3"}`,children:j?e.jsx($,{className:`text-gray-900 animate-spin ${p?"w-4 h-4":"w-5 h-5"}`}):e.jsx(V,{className:`text-gray-900 ${p?"w-4 h-4":"w-5 h-5"}`})})]})})]})}function W(){const l=n.useRef(null);return n.useEffect(()=>{l.current=new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"+btoa(String.fromCharCode.apply(null,Array(1e3).fill(128).map((f,m)=>Math.sin(m*.1)*50+128)))),l.current.volume=.3},[]),n.useCallback(()=>{l.current&&(l.current.currentTime=0,l.current.play().catch(()=>{}))},[])}function ae(){const{user:l}=Q(),{language:a}=T(),[f,m]=n.useState([]),[r,c]=n.useState(null),[b,h]=n.useState(!0),[y,g]=n.useState(null),[C,w]=n.useState(null),j=n.useRef(0),s=W(),i=l?.role==="resident",x=n.useCallback(async()=>{try{if(g(null),i){const u=await A.getOrCreateSupportChannel();u&&u.id?w(u):g(a==="ru"?"Не удалось создать чат":"Chat yaratib bo'lmadi")}else{const k=(await A.getChannels()).channels||[],U=k.reduce((p,t)=>p+(t.unread_count||0),0);U>j.current&&j.current>0&&s(),j.current=U,m(k)}}catch{g(a==="ru"?"Ошибка загрузки":"Yuklanmadi")}},[i,s,a]);n.useEffect(()=>{h(!0),x().finally(()=>h(!1))},[x]),n.useEffect(()=>{if(i)return;const u=setInterval(x,5e3);return()=>clearInterval(u)},[x,i]);const N=f.find(u=>u.id===r);return i?b?e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex items-center justify-center",children:e.jsx($,{className:"w-8 h-8 animate-spin text-gray-400"})})}):C?e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex flex-col",children:e.jsx(D,{channelId:C.id,channel:C,onBack:()=>window.history.back(),hideBackOnDesktop:!0})})}):e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex flex-col items-center justify-center gap-4 p-6",children:[e.jsx(q,{className:"w-12 h-12 text-red-400"}),e.jsx("p",{className:"text-gray-500 text-center",children:y||(a==="ru"?"Ошибка загрузки чата":"Chat yuklanmadi")}),e.jsx("button",{onClick:()=>{h(!0),g(null),x().finally(()=>h(!1))},className:"px-4 py-2 bg-primary-500 text-gray-900 rounded-xl hover:bg-primary-600 transition-colors",children:a==="ru"?"Повторить":"Qayta urinish"})]})}):e.jsx("div",{className:"h-[calc(100vh-180px)] md:h-[calc(100vh-140px)] bg-white rounded-2xl shadow-sm border overflow-hidden",children:e.jsxs("div",{className:"h-full flex",children:[e.jsx("div",{className:`${r?"hidden md:block":"block"} w-full md:w-80 lg:w-96 border-r bg-white/80 backdrop-blur-sm`,children:e.jsx(Y,{channels:f,onSelectChannel:c,selectedChannelId:r,isLoading:b})}),e.jsx("div",{className:`${r?"block":"hidden md:flex"} flex-1 bg-gray-50/50`,children:r?e.jsx(D,{channelId:r,channel:N,onBack:()=>c(null)}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(L,{className:"w-10 h-10 text-gray-400"})}),e.jsx("p",{className:"text-gray-500",children:a==="ru"?"Выберите чат для просмотра":"Ko'rish uchun chatni tanlang"})]})})})]})})}export{ae as ChatPage};
//# sourceMappingURL=ChatPage-1768936274458-B9qG93eo.js.map
