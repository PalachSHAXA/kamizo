import{ba as W,r as t,j as e,au as Y,z as ee,$ as se,ab as G,X as ae,U as P,aB as te,B as le,D as U}from"./react-vendor-1768933176788-DCR-SgXi.js";import{b as ne,u as ie,S as I,F as re,j as ce,x as de}from"./index-1768933176788-BGyFroaV.js";import{f as me}from"./formatAddress-1768933176788-OwpdX0o2.js";import"./vendor-1768933176788-DJrKjBEl.js";import"./qr-scanner-1768933176788-cr32YHjo.js";import"./zustand-1768933176788-wNUYBKDB.js";function be(){const{user:p}=ne(),{requests:v,executors:o,assignRequest:D,addRequest:j,fetchRequests:C,fetchExecutors:u,isLoadingRequests:L}=ie(),[B]=W(),N=B.get("status")||"all",[x,R]=t.useState(N),[d,A]=t.useState(""),[h,b]=t.useState(null),[k,y]=t.useState(!1),w=["manager","admin","director"].includes(p?.role||"");t.useEffect(()=>{R(N)},[N]);const m=p?.role==="department_head",n=p?.specialization,f=t.useMemo(()=>m&&n?v.filter(a=>a.category===n):v,[v,m,n]),c=t.useMemo(()=>m&&n?o.filter(a=>a.specialization===n):o,[o,m,n]);t.useEffect(()=>{C(),u()},[C,u]),t.useEffect(()=>{h&&u()},[h,u]);const E=a=>{switch(a){case"new":return e.jsx("span",{className:"badge badge-new",children:"Новая"});case"assigned":return e.jsx("span",{className:"badge bg-indigo-100 text-indigo-700",children:"Назначена"});case"accepted":return e.jsx("span",{className:"badge bg-cyan-100 text-cyan-700",children:"Принята"});case"in_progress":return e.jsx("span",{className:"badge badge-progress",children:"В работе"});case"pending_approval":return e.jsx("span",{className:"badge bg-purple-100 text-purple-700",children:"Ожидает подтверждения"});case"completed":return e.jsx("span",{className:"badge badge-done",children:"Выполнена"});default:return e.jsx("span",{className:"badge",children:a})}},i=f.filter(a=>{let l=!1;x==="all"?l=!0:x==="in_progress"?l=["assigned","accepted","in_progress"].includes(a.status):l=a.status===x;const g=d===""||a.title.toLowerCase().includes(d.toLowerCase())||a.residentName?.toLowerCase().includes(d.toLowerCase())||a.number.toString().includes(d)||a.address?.toLowerCase().includes(d.toLowerCase());return l&&g});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:m?"Заявки отдела":"Заявки"}),m&&n&&e.jsxs("p",{className:"text-gray-500 text-sm mt-1",children:["Отдел: ",I[n]]})]}),w&&e.jsxs("button",{onClick:()=>y(!0),className:"btn-primary flex items-center gap-2",children:[e.jsx(Y,{className:"w-5 h-5"}),e.jsx("span",{className:"hidden sm:inline",children:"Создать заявку"})]})]}),e.jsxs("div",{className:"glass-card p-4 flex items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Поиск по номеру, названию, адресу...",value:d,onChange:a=>A(a.target.value),className:"glass-input pl-10"})]}),e.jsxs("select",{value:x,onChange:a=>R(a.target.value),className:"glass-input w-48",children:[e.jsx("option",{value:"all",children:"Все статусы"}),e.jsx("option",{value:"new",children:"Новые"}),e.jsx("option",{value:"assigned",children:"Назначенные"}),e.jsx("option",{value:"accepted",children:"Принятые"}),e.jsx("option",{value:"in_progress",children:"В работе"}),e.jsx("option",{value:"pending_approval",children:"Ожидают подтверждения"}),e.jsx("option",{value:"completed",children:"Выполненные"})]})]}),L?e.jsxs("div",{className:"flex justify-center items-center py-12",children:[e.jsx(se,{className:"w-8 h-8 animate-spin text-primary-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Загрузка заявок..."})]}):i.length===0?e.jsx("div",{className:"glass-card p-8 text-center text-gray-500",children:"Заявки не найдены"}):e.jsx("div",{className:"space-y-3",children:i.map(a=>e.jsx("div",{className:"glass-card p-5",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:`w-3 h-3 mt-1.5 rounded-full ${a.priority==="urgent"?"bg-red-500":a.priority==="high"?"bg-orange-500":a.priority==="medium"?"bg-amber-500":"bg-gray-400"}`}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-sm text-gray-500",children:["#",a.number]}),e.jsx("h3",{className:"font-semibold text-lg",children:a.title}),E(a.status)]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[e.jsx("span",{className:"font-medium",children:I[a.category]})," • ",a.residentName]}),e.jsx("div",{className:"flex items-center gap-4 mt-2 text-sm text-gray-500",children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(G,{className:"w-4 h-4"}),me(a.address,a.apartment)]})}),a.executorName&&e.jsxs("div",{className:"mt-2 text-sm text-primary-600",children:["Исполнитель: ",a.executorName]})]})]}),e.jsx("div",{className:"flex gap-2",children:a.status==="new"&&e.jsx("button",{onClick:()=>b(a.id),className:"btn-primary text-sm py-2 px-4",children:"Назначить"})})]})},a.id))}),h&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-content p-6 w-full max-w-md mx-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Назначить исполнителя"}),e.jsx("div",{className:"space-y-3",children:c.length===0?e.jsx("p",{className:"text-gray-500 text-center py-4",children:"Загрузка исполнителей..."}):c.map(a=>e.jsxs("button",{onClick:()=>{D(h,a.id),b(null)},className:"w-full p-4 bg-white/30 hover:bg-white/50 rounded-xl text-left transition-colors",children:[e.jsx("div",{className:"font-medium",children:a.name}),e.jsxs("div",{className:"text-sm text-gray-500",children:[I[a.specialization]," • ",a.activeRequests," активных заявок"]})]},a.id))}),e.jsx("button",{onClick:()=>b(null),className:"btn-secondary w-full mt-4",children:"Отмена"})]})}),k&&e.jsx(oe,{onClose:()=>y(!1),onSubmit:async a=>{await j(a),y(!1)}})]})}function oe({onClose:p,onSubmit:v}){const[o,D]=t.useState(""),[j,C]=t.useState(""),[u,L]=t.useState("plumber"),[B,N]=t.useState("medium"),[x,R]=t.useState(""),[d,A]=t.useState(""),[h,b]=t.useState(!1),[k,y]=t.useState([]),[w,m]=t.useState([]),[n,f]=t.useState([]),[c,E]=t.useState(""),[i,a]=t.useState(""),[l,g]=t.useState(null),[T,z]=t.useState(!1),[F,$]=t.useState(!1),[O,Q]=t.useState(!1);t.useEffect(()=>{(async()=>{z(!0);try{const r=await re.getAll();y(r.branches||[])}catch{}finally{z(!1)}})()},[]),t.useEffect(()=>{if(!c){m([]),a(""),f([]),g(null);return}(async()=>{$(!0),a(""),f([]),g(null);try{const _=((await ce.getAll()).buildings||[]).filter(V=>V.branch_code===c);m(_)}catch{}finally{$(!1)}})()},[c]),t.useEffect(()=>{if(!i){f([]),g(null);return}(async()=>{Q(!0),g(null);try{const r=await de.getAll({role:"resident",building_id:i,limit:500});f(r.users||[])}catch{}finally{Q(!1)}})()},[i]);const H=[{value:"plumber",label:"Сантехник"},{value:"electrician",label:"Электрик"},{value:"security",label:"Охрана"},{value:"cleaning",label:"Уборка"},{value:"elevator",label:"Лифт"},{value:"intercom",label:"Домофон"},{value:"carpenter",label:"Плотник"},{value:"boiler",label:"Котёл"},{value:"other",label:"Другое"}],X=[{value:"09:00-11:00",label:"09:00 - 11:00"},{value:"11:00-13:00",label:"11:00 - 13:00"},{value:"13:00-15:00",label:"13:00 - 15:00"},{value:"15:00-17:00",label:"15:00 - 17:00"},{value:"17:00-19:00",label:"17:00 - 19:00"}],Z=()=>new Date().toISOString().split("T")[0],q=()=>{const s=new Date;return s.setDate(s.getDate()+30),s.toISOString().split("T")[0]},J=s=>{const r=n.find(_=>_.id===s);g(r||null)},K=async s=>{if(s.preventDefault(),!(!o.trim()||!j.trim()||!l)){b(!0);try{await v({title:o,description:j,category:u,priority:B,residentId:l.id,residentName:l.name,residentPhone:l.phone||"Не указан",address:l.address||w.find(r=>r.id===i)?.address||"",apartment:l.apartment||"0",scheduledDate:x||void 0,scheduledTime:d||void 0})}finally{b(!1)}}},M=k.find(s=>s.code===c)?.name,S=w.find(s=>s.id===i);return e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-content p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Создать заявку"}),e.jsx("button",{onClick:p,className:"p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(ae,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:K,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Категория *"}),e.jsx("select",{value:u,onChange:s=>L(s.target.value),className:"glass-input w-full",required:!0,children:H.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Заголовок *"}),e.jsx("input",{type:"text",value:o,onChange:s=>D(s.target.value),className:"glass-input w-full",placeholder:"Кратко опишите проблему",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Описание *"}),e.jsx("textarea",{value:j,onChange:s=>C(s.target.value),className:"glass-input w-full min-h-[100px] resize-none",placeholder:"Подробное описание проблемы",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Приоритет"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["low","medium","high","urgent"].map(s=>e.jsx("button",{type:"button",onClick:()=>N(s),className:`py-2 px-3 rounded-lg text-sm font-medium transition-all ${B===s?s==="urgent"?"bg-red-500 text-white":s==="high"?"bg-orange-500 text-white":s==="medium"?"bg-amber-500 text-white":"bg-gray-500 text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:s==="low"?"Низкий":s==="medium"?"Средний":s==="high"?"Высокий":"Срочный"},s))})]}),e.jsxs("div",{className:"border-t pt-4 mt-4",children:[e.jsxs("h3",{className:"font-medium text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"Выбор жителя"]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-1",children:[e.jsx(te,{className:"w-4 h-4"}),"Филиал *"]}),e.jsxs("select",{value:c,onChange:s=>E(s.target.value),className:"glass-input w-full",disabled:T,children:[e.jsx("option",{value:"",children:T?"Загрузка...":"Выберите филиал"}),k.map(s=>e.jsx("option",{value:s.code,children:s.name},s.code))]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-1",children:[e.jsx(le,{className:"w-4 h-4"}),"Дом *"]}),e.jsxs("select",{value:i,onChange:s=>a(s.target.value),className:"glass-input w-full",disabled:!c||F,children:[e.jsx("option",{value:"",children:F?"Загрузка...":c?"Выберите дом":"Сначала выберите филиал"}),w.map(s=>e.jsxs("option",{value:s.id,children:[s.name," - ",s.address]},s.id))]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-1",children:[e.jsx(P,{className:"w-4 h-4"}),"Житель *"]}),e.jsxs("select",{value:l?.id||"",onChange:s=>J(s.target.value),className:"glass-input w-full",disabled:!i||O,children:[e.jsx("option",{value:"",children:O?"Загрузка...":i?"Выберите жителя":"Сначала выберите дом"}),n.map(s=>e.jsxs("option",{value:s.id,children:[s.name," ",s.apartment?`- кв. ${s.apartment}`:""]},s.id))]})]}),l&&e.jsx("div",{className:"bg-primary-50 border border-primary-200 rounded-xl p-4 mt-3",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center",children:e.jsx(P,{className:"w-5 h-5 text-primary-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:l.name}),e.jsx("p",{className:"text-sm text-gray-600",children:l.phone||"Телефон не указан"}),e.jsxs("p",{className:"text-sm text-gray-500 flex items-center gap-1 mt-1",children:[e.jsx(G,{className:"w-3 h-3"}),S?.address||l.address,l.apartment&&`, кв. ${l.apartment}`]})]})]})}),(M||S)&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500 mt-2 flex-wrap",children:[M&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"bg-gray-100 px-2 py-1 rounded",children:M}),S&&e.jsx(U,{className:"w-3 h-3"})]}),S&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"bg-gray-100 px-2 py-1 rounded",children:S.name}),l&&e.jsx(U,{className:"w-3 h-3"})]}),l&&e.jsx("span",{className:"bg-primary-100 text-primary-700 px-2 py-1 rounded",children:l.name})]})]}),e.jsxs("div",{className:"border-t pt-4 mt-4",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-3",children:"Желаемое время (опционально)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Дата"}),e.jsx("input",{type:"date",value:x,onChange:s=>R(s.target.value),className:"glass-input w-full",min:Z(),max:q()})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Время"}),e.jsxs("select",{value:d,onChange:s=>A(s.target.value),className:"glass-input w-full",children:[e.jsx("option",{value:"",children:"Любое время"}),X.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:p,className:"btn-secondary flex-1",children:"Отмена"}),e.jsx("button",{type:"submit",disabled:h||!o.trim()||!j.trim()||!l,className:"btn-primary flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:h?"Создание...":"Создать заявку"})]})]})]})})}export{be as RequestsPage};
//# sourceMappingURL=RequestsPage-1768933176788-BP8lWJA7.js.map
