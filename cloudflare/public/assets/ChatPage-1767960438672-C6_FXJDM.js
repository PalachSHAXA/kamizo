import{r as n,j as e,O as U,I,i as z,aw as Q,aY as R,U as $,aZ as F,$ as O,ak as V,x as Y,h as E,B as M,a2 as L,W as q,n as G}from"./react-vendor-1767960438672-BQZVGAFz.js";import{b as D,d as T,z as k,C as H,E as Z}from"./index-1767960438672-C3luc8oy.js";import"./vendor-1767960438672-DswYihKv.js";import"./qr-scanner-1767960438672-cr32YHjo.js";import"./zustand-1767960438672-wNUYBKDB.js";function K({role:l,language:r}){const f={admin:{label:"Админ",labelUz:"Admin",color:"bg-red-100 text-red-700",icon:e.jsx(G,{className:"w-3 h-3"})},manager:{label:"Менеджер",labelUz:"Menejer",color:"bg-purple-100 text-purple-700",icon:e.jsx(L,{className:"w-3 h-3"})},executor:{label:"Исполнитель",labelUz:"Ijrochi",color:"bg-orange-100 text-orange-700",icon:e.jsx(q,{className:"w-3 h-3"})},resident:{label:"Житель",labelUz:"Turar joy egasi",color:"bg-blue-100 text-blue-700",icon:e.jsx($,{className:"w-3 h-3"})},tenant:{label:"Арендатор",labelUz:"Ijarachi",color:"bg-green-100 text-green-700",icon:e.jsx($,{className:"w-3 h-3"})},commercial_owner:{label:"Коммерция",labelUz:"Tijorat",color:"bg-yellow-100 text-yellow-700",icon:e.jsx(M,{className:"w-3 h-3"})},department_head:{label:"Глава отдела",labelUz:"Bo'lim boshlig'i",color:"bg-indigo-100 text-indigo-700",icon:e.jsx(L,{className:"w-3 h-3"})},director:{label:"Директор",labelUz:"Direktor",color:"bg-rose-100 text-rose-700",icon:e.jsx(L,{className:"w-3 h-3"})}},m=f[l]||f.resident;return e.jsxs("span",{className:`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium ${m.color}`,children:[m.icon,r==="ru"?m.label:m.labelUz]})}function X({channels:l,onSelectChannel:r,selectedChannelId:f,isLoading:m}){const{language:a}=T(),[c,b]=n.useState(""),g=l.filter(s=>{if(!c.trim())return!0;const i=c.toLowerCase();return s.name?.toLowerCase().includes(i)||s.description?.toLowerCase().includes(i)||s.last_message?.toLowerCase().includes(i)}),j=(s,i)=>{const x=s.unread_count||0,N=i.unread_count||0;if(N!==x)return N-x;const u=s.last_message_at?new Date(s.last_message_at).getTime():0;return(i.last_message_at?new Date(i.last_message_at).getTime():0)-u},h=g.filter(s=>s.type==="private_support").sort(j),_=g.filter(s=>s.type==="uk_general"||s.type==="building_general").sort(j),w=l.reduce((s,i)=>s+(i.unread_count||0),0),y=s=>{switch(s){case"uk_general":return e.jsx(M,{className:"w-5 h-5"});case"building_general":return e.jsx(E,{className:"w-5 h-5"});case"private_support":return e.jsx($,{className:"w-5 h-5"});default:return e.jsx(z,{className:"w-5 h-5"})}};return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"p-4 border-b bg-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold",children:a==="ru"?"Сообщения":"Xabarlar"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:a==="ru"?"Чаты с жителями и группы":"Aholi bilan chatlar va guruhlar"})]}),w>0&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-red-100 text-red-600 rounded-full",children:[e.jsx("span",{className:"text-sm font-medium",children:w}),e.jsx("span",{className:"text-xs",children:a==="ru"?"новых":"yangi"})]})]})}),e.jsx("div",{className:"p-3 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx(Y,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",value:c,onChange:s=>b(s.target.value),placeholder:a==="ru"?"Поиск по имени или сообщению...":"Ism yoki xabar bo'yicha qidirish...",className:"w-full pl-9 pr-4 py-2 bg-gray-100 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:m?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(U,{className:"w-6 h-6 animate-spin text-gray-400"})}):e.jsxs(e.Fragment,{children:[h.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"px-4 py-2 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider",children:[a==="ru"?"Обращения жителей":"Aholi murojatları"," (",h.length,")"]}),e.jsx("div",{className:"divide-y",children:h.map(s=>{const i=f===s.id;return e.jsxs("button",{onClick:()=>r(s.id),className:`w-full p-4 flex items-center gap-3 text-left hover:bg-gray-50 transition-colors ${i?"bg-primary-50":""} ${s.unread_count&&s.unread_count>0?"bg-blue-50/50":""}`,children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-medium text-lg",children:s.name&&!/^\d/.test(s.name)?s.name.charAt(0).toUpperCase():"U"}),s.unread_count&&s.unread_count>0&&e.jsx("div",{className:"absolute -top-1 -right-1 min-w-5 h-5 bg-red-500 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-white font-medium px-1",children:s.unread_count>99?"99+":s.unread_count})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`truncate ${s.unread_count&&s.unread_count>0?"font-semibold":"font-medium"}`,children:s.name}),s.last_message_at&&e.jsx("span",{className:`text-xs ${s.unread_count&&s.unread_count>0?"text-blue-500 font-medium":"text-gray-400"}`,children:new Date(s.last_message_at).toLocaleTimeString(a==="ru"?"ru-RU":"uz-UZ",{hour:"2-digit",minute:"2-digit"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.description&&e.jsx("span",{className:"text-xs text-gray-400",children:s.description}),e.jsx("span",{className:`text-sm truncate ${s.unread_count&&s.unread_count>0?"text-gray-700 font-medium":"text-gray-500"}`,children:s.last_message||""})]})]})]},s.id)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"px-4 py-2 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider",children:a==="ru"?"Групповые чаты":"Guruh chatlari"}),e.jsx("div",{className:"divide-y",children:_.map(s=>{const i=Z[s.type],x=f===s.id;return e.jsxs("button",{onClick:()=>r(s.id),className:`w-full p-4 flex items-center gap-3 text-left hover:bg-gray-50 transition-colors ${x?"bg-primary-50":""}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${s.type==="uk_general"?"bg-purple-100 text-purple-600":"bg-green-100 text-green-600"}`,children:y(s.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium truncate",children:a==="ru"?i.label:i.labelUz}),s.last_message_at&&e.jsx("span",{className:"text-xs text-gray-400",children:new Date(s.last_message_at).toLocaleTimeString(a==="ru"?"ru-RU":"uz-UZ",{hour:"2-digit",minute:"2-digit"})})]}),s.message_count&&s.message_count>0?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(E,{className:"w-3.5 h-3.5"}),e.jsxs("span",{children:[s.message_count," ",a==="ru"?"сообщений":"xabar"]})]}):e.jsx("p",{className:"text-sm text-gray-400",children:a==="ru"?"Нет сообщений":"Xabar yo'q"})]})]},s.id)})})]})]})})]})}function B({channelId:l,channel:r,onBack:f,hideBackOnDesktop:m=!1}){const{user:a}=D(),{language:c}=T(),[b,g]=n.useState([]),[j,h]=n.useState(""),[_,w]=n.useState(!0),[y,s]=n.useState(!1),i=n.useRef(null),x=n.useCallback(async()=>{if(!l||l==="undefined"){w(!1);return}try{const d=(await k.getMessages(l)).messages||[];g(d)}catch{}finally{w(!1)}},[l]),N=n.useCallback(async()=>{if(!(!l||l==="undefined"))try{await k.markRead(l)}catch{}},[l]);n.useEffect(()=>{w(!0),x(),N();const t=H(d=>{if(d.channel_id===l){if(d.type==="read"){g(o=>o.map(v=>v.id===d.message_id?{...v,read_by:[...v.read_by||[],d.user_id]}:v));return}g(o=>o.some(S=>S.id===d.id)?o:[...o,d]),N()}});return()=>{t()}},[x,l,N]),n.useEffect(()=>{const t=setTimeout(()=>{i.current?.scrollIntoView({behavior:"smooth"})},100);return()=>clearTimeout(t)},[b.length]);const u=async()=>{if(!j.trim()||!a||y)return;const t=j.trim();h(""),s(!0);try{const d=await k.sendMessage(l,t);d.message&&g(o=>o.some(S=>S.id===d.message.id)?o:[...o,d.message])}catch{h(t),alert("Не удалось отправить сообщение")}finally{s(!1)}},C=()=>{if(r?.type==="private_support")return a?.role==="resident"?c==="ru"?"Чат с администрацией":"Administratsiya bilan chat":r.name||"Чат";if(r){const t=Z[r.type];return c==="ru"?t.label:t.labelUz}return c==="ru"?"Чат":"Chat"},A=()=>r?.type==="private_support"?a?.role==="resident"?c==="ru"?"Личный чат":"Shaxsiy chat":r.description||"":`${b.length} ${c==="ru"?"сообщений":"xabar"}`,p=a?.role==="resident"&&r?.type==="private_support";return e.jsxs("div",{className:"h-full flex flex-col bg-gray-50",children:[e.jsxs("div",{className:`bg-white border-b flex items-center gap-3 ${p?"p-3":"p-4"}`,children:[!m&&e.jsx("button",{onClick:f,className:"p-2 hover:bg-gray-100 rounded-xl md:hidden",children:e.jsx(Q,{className:"w-5 h-5"})}),e.jsx("div",{className:`rounded-full flex items-center justify-center ${p?"w-8 h-8":"w-10 h-10"} ${r?.type==="private_support"?"bg-blue-100 text-blue-600":r?.type==="uk_general"?"bg-purple-100 text-purple-600":r?.type==="building_general"?"bg-green-100 text-green-600":r?.type==="entrance"?"bg-amber-100 text-amber-600":"bg-gray-100 text-gray-600"}`,children:r?.type==="private_support"?a?.role==="resident"?e.jsx(R,{className:p?"w-4 h-4":"w-5 h-5"}):e.jsx($,{className:"w-5 h-5"}):e.jsx(z,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:`font-medium ${p?"text-sm":""}`,children:C()}),!p&&e.jsx("p",{className:"text-xs text-gray-500",children:A()})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:_?e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsx(U,{className:"w-8 h-8 animate-spin text-gray-400"})}):b.length===0?e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-center",children:[e.jsx(R,{className:"w-10 h-10 text-gray-300 mb-3"}),e.jsx("p",{className:"text-gray-400 text-sm",children:c==="ru"?"Напишите ваш вопрос":"Savolingizni yozing"})]}):e.jsxs(e.Fragment,{children:[b.map((t,d)=>{const o=t.sender_id===a?.id,v=d===0||b[d-1].sender_id!==t.sender_id,S=!o&&v;return e.jsx("div",{className:`flex ${o?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[80%] ${o?"order-1":""}`,children:[S&&e.jsxs("div",{className:"flex items-center gap-2 mb-1 px-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:t.sender_name}),e.jsx(K,{role:t.sender_role,language:c})]}),e.jsxs("div",{className:`px-4 py-2 rounded-2xl ${o?"bg-primary-500 text-gray-900 rounded-br-md":"bg-white text-gray-900 rounded-bl-md shadow-sm"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.content}),e.jsxs("div",{className:`flex items-center justify-end gap-1 mt-1 ${o?"text-gray-700":"text-gray-400"}`,children:[e.jsx("span",{className:"text-[10px]",children:new Date(t.created_at).toLocaleTimeString(c==="ru"?"ru-RU":"uz-UZ",{hour:"2-digit",minute:"2-digit"})}),o&&(t.read_by&&t.read_by.length>1?e.jsx(F,{className:"w-3 h-3"}):e.jsx(O,{className:"w-3 h-3"}))]})]})]})},t.id)}),e.jsx("div",{ref:i})]})}),e.jsx("div",{className:`bg-white border-t ${p?"p-3":"p-4"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:j,onChange:t=>h(t.target.value),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),u())},placeholder:c==="ru"?"Написать...":"Yozing...",className:`flex-1 bg-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 ${p?"px-3 py-2.5 text-sm":"px-4 py-3"}`,disabled:y}),e.jsx("button",{onClick:u,disabled:!j.trim()||y,className:`bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 rounded-xl transition-colors ${p?"p-2.5":"p-3"}`,children:y?e.jsx(U,{className:`text-gray-900 animate-spin ${p?"w-4 h-4":"w-5 h-5"}`}):e.jsx(V,{className:`text-gray-900 ${p?"w-4 h-4":"w-5 h-5"}`})})]})})]})}function W(){const l=n.useRef(null);return n.useEffect(()=>{l.current=new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"+btoa(String.fromCharCode.apply(null,Array(1e3).fill(128).map((f,m)=>Math.sin(m*.1)*50+128)))),l.current.volume=.3},[]),n.useCallback(()=>{l.current&&(l.current.currentTime=0,l.current.play().catch(()=>{}))},[])}function re(){const{user:l}=D(),{language:r}=T(),[f,m]=n.useState([]),[a,c]=n.useState(null),[b,g]=n.useState(!0),[j,h]=n.useState(null),[_,w]=n.useState(null),y=n.useRef(0),s=W(),i=l?.role==="resident",x=n.useCallback(async()=>{try{if(h(null),i){const u=await k.getOrCreateSupportChannel();u&&u.id?w(u):h(r==="ru"?"Не удалось создать чат":"Chat yaratib bo'lmadi")}else{const C=(await k.getChannels()).channels||[],A=C.reduce((p,t)=>p+(t.unread_count||0),0);A>y.current&&y.current>0&&s(),y.current=A,m(C)}}catch{h(r==="ru"?"Ошибка загрузки":"Yuklanmadi")}},[i,s,r]);n.useEffect(()=>{g(!0),x().finally(()=>g(!1))},[x]),n.useEffect(()=>{if(i)return;const u=setInterval(x,5e3);return()=>clearInterval(u)},[x,i]);const N=f.find(u=>u.id===a);return i?b?e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex items-center justify-center",children:e.jsx(U,{className:"w-8 h-8 animate-spin text-gray-400"})})}):_?e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex flex-col",children:e.jsx(B,{channelId:_.id,channel:_,onBack:()=>window.history.back(),hideBackOnDesktop:!0})})}):e.jsx("div",{className:"max-w-lg mx-auto",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex flex-col items-center justify-center gap-4 p-6",children:[e.jsx(I,{className:"w-12 h-12 text-red-400"}),e.jsx("p",{className:"text-gray-500 text-center",children:j||(r==="ru"?"Ошибка загрузки чата":"Chat yuklanmadi")}),e.jsx("button",{onClick:()=>{g(!0),h(null),x().finally(()=>g(!1))},className:"px-4 py-2 bg-primary-500 text-gray-900 rounded-xl hover:bg-primary-600 transition-colors",children:r==="ru"?"Повторить":"Qayta urinish"})]})}):e.jsx("div",{className:"h-[calc(100vh-180px)] md:h-[calc(100vh-140px)] bg-white rounded-2xl shadow-sm border overflow-hidden",children:e.jsxs("div",{className:"h-full flex",children:[e.jsx("div",{className:`${a?"hidden md:block":"block"} w-full md:w-80 lg:w-96 border-r bg-white/80 backdrop-blur-sm`,children:e.jsx(X,{channels:f,onSelectChannel:c,selectedChannelId:a,isLoading:b})}),e.jsx("div",{className:`${a?"block":"hidden md:flex"} flex-1 bg-gray-50/50`,children:a?e.jsx(B,{channelId:a,channel:N,onBack:()=>c(null)}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(z,{className:"w-10 h-10 text-gray-400"})}),e.jsx("p",{className:"text-gray-500",children:r==="ru"?"Выберите чат для просмотра":"Ko'rish uchun chatni tanlang"})]})})})]})})}export{re as ChatPage};
//# sourceMappingURL=ChatPage-1767960438672-C6_FXJDM.js.map
