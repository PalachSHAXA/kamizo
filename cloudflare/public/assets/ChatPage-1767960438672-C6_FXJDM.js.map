{"version":3,"file":"ChatPage-1767960438672-C6_FXJDM.js","sources":["../../src/pages/ChatPage.tsx"],"sourcesContent":["import { useState, useRef, useEffect, useCallback } from 'react';\nimport {\n  MessageCircle, Send, ArrowLeft, Users, Building2,\n  HeadphonesIcon, Search, Check, CheckCheck,\n  User, Crown, Shield, Wrench, Loader2, AlertCircle\n} from 'lucide-react';\nimport { useAuthStore } from '../stores/authStore';\nimport { useLanguageStore } from '../stores/languageStore';\nimport { chatApi } from '../services/api';\nimport { subscribeToChatMessages } from '../hooks/useWebSocketSync';\nimport { CHAT_CHANNEL_LABELS, type ChatChannelType, type UserRole } from '../types';\n\n// Types for API responses\ninterface ChatChannel {\n  id: string;\n  type: ChatChannelType;\n  name: string;\n  description?: string;\n  building_id?: string;\n  resident_id?: string;\n  message_count?: number;\n  last_message?: string;\n  last_message_at?: string;\n  last_sender_id?: string;\n  unread_count?: number;\n  created_at: string;\n}\n\ninterface ChatMessage {\n  id: string;\n  channel_id: string;\n  sender_id: string;\n  sender_name: string;\n  sender_role: UserRole;\n  content: string;\n  created_at: string;\n  read_by?: string[];\n}\n\n// Role badge component\nfunction RoleBadge({ role, language }: { role: UserRole; language: string }) {\n  const roleConfig: Record<UserRole, { label: string; labelUz: string; color: string; icon: React.ReactNode }> = {\n    admin: {\n      label: 'Админ',\n      labelUz: 'Admin',\n      color: 'bg-red-100 text-red-700',\n      icon: <Shield className=\"w-3 h-3\" />\n    },\n    manager: {\n      label: 'Менеджер',\n      labelUz: 'Menejer',\n      color: 'bg-purple-100 text-purple-700',\n      icon: <Crown className=\"w-3 h-3\" />\n    },\n    executor: {\n      label: 'Исполнитель',\n      labelUz: 'Ijrochi',\n      color: 'bg-orange-100 text-orange-700',\n      icon: <Wrench className=\"w-3 h-3\" />\n    },\n    resident: {\n      label: 'Житель',\n      labelUz: 'Turar joy egasi',\n      color: 'bg-blue-100 text-blue-700',\n      icon: <User className=\"w-3 h-3\" />\n    },\n    tenant: {\n      label: 'Арендатор',\n      labelUz: 'Ijarachi',\n      color: 'bg-green-100 text-green-700',\n      icon: <User className=\"w-3 h-3\" />\n    },\n    commercial_owner: {\n      label: 'Коммерция',\n      labelUz: 'Tijorat',\n      color: 'bg-yellow-100 text-yellow-700',\n      icon: <Building2 className=\"w-3 h-3\" />\n    },\n    department_head: {\n      label: 'Глава отдела',\n      labelUz: 'Bo\\'lim boshlig\\'i',\n      color: 'bg-indigo-100 text-indigo-700',\n      icon: <Crown className=\"w-3 h-3\" />\n    },\n    director: {\n      label: 'Директор',\n      labelUz: 'Direktor',\n      color: 'bg-rose-100 text-rose-700',\n      icon: <Crown className=\"w-3 h-3\" />\n    }\n  };\n\n  const config = roleConfig[role] || roleConfig.resident;\n\n  return (\n    <span className={`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium ${config.color}`}>\n      {config.icon}\n      {language === 'ru' ? config.label : config.labelUz}\n    </span>\n  );\n}\n\n// Channel list for admin/manager - shows private support chats from residents\nfunction AdminChannelList({\n  channels,\n  onSelectChannel,\n  selectedChannelId,\n  isLoading\n}: {\n  channels: ChatChannel[];\n  onSelectChannel: (channelId: string) => void;\n  selectedChannelId: string | null;\n  isLoading: boolean;\n}) {\n  const { language } = useLanguageStore();\n  const [searchQuery, setSearchQuery] = useState('');\n\n  // Filter channels by search query\n  const filteredChannels = channels.filter(ch => {\n    if (!searchQuery.trim()) return true;\n    const query = searchQuery.toLowerCase();\n    return (\n      ch.name?.toLowerCase().includes(query) ||\n      ch.description?.toLowerCase().includes(query) ||\n      ch.last_message?.toLowerCase().includes(query)\n    );\n  });\n\n  // Separate private support and group channels (from filtered)\n  // Sort by unread count (unread first), then by last_message_at\n  const sortByUnread = (a: ChatChannel, b: ChatChannel) => {\n    // First, sort by unread count (channels with unread messages first)\n    const aUnread = a.unread_count || 0;\n    const bUnread = b.unread_count || 0;\n    if (bUnread !== aUnread) return bUnread - aUnread;\n    // Then by last message time\n    const aTime = a.last_message_at ? new Date(a.last_message_at).getTime() : 0;\n    const bTime = b.last_message_at ? new Date(b.last_message_at).getTime() : 0;\n    return bTime - aTime;\n  };\n\n  const privateSupportChannels = filteredChannels\n    .filter(ch => ch.type === 'private_support')\n    .sort(sortByUnread);\n  const groupChannels = filteredChannels\n    .filter(ch => ch.type === 'uk_general' || ch.type === 'building_general')\n    .sort(sortByUnread);\n\n  // Calculate total unread\n  const totalUnread = channels.reduce((sum, ch) => sum + (ch.unread_count || 0), 0);\n\n  const getChannelIcon = (type: ChatChannelType) => {\n    switch (type) {\n      case 'uk_general': return <Building2 className=\"w-5 h-5\" />;\n      case 'building_general': return <Users className=\"w-5 h-5\" />;\n      case 'private_support': return <User className=\"w-5 h-5\" />;\n      default: return <MessageCircle className=\"w-5 h-5\" />;\n    }\n  };\n\n  return (\n    <div className=\"h-full flex flex-col\">\n      {/* Header */}\n      <div className=\"p-4 border-b bg-white\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h2 className=\"text-lg font-bold\">\n              {language === 'ru' ? 'Сообщения' : 'Xabarlar'}\n            </h2>\n            <p className=\"text-sm text-gray-500 mt-1\">\n              {language === 'ru' ? 'Чаты с жителями и группы' : 'Aholi bilan chatlar va guruhlar'}\n            </p>\n          </div>\n          {totalUnread > 0 && (\n            <div className=\"flex items-center gap-2 px-3 py-1 bg-red-100 text-red-600 rounded-full\">\n              <span className=\"text-sm font-medium\">{totalUnread}</span>\n              <span className=\"text-xs\">{language === 'ru' ? 'новых' : 'yangi'}</span>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Search */}\n      <div className=\"p-3 border-b\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400\" />\n          <input\n            type=\"text\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            placeholder={language === 'ru' ? 'Поиск по имени или сообщению...' : 'Ism yoki xabar bo\\'yicha qidirish...'}\n            className=\"w-full pl-9 pr-4 py-2 bg-gray-100 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-500\"\n          />\n        </div>\n      </div>\n\n      {/* Channel list */}\n      <div className=\"flex-1 overflow-y-auto\">\n        {isLoading ? (\n          <div className=\"flex items-center justify-center py-8\">\n            <Loader2 className=\"w-6 h-6 animate-spin text-gray-400\" />\n          </div>\n        ) : (\n          <>\n            {/* Private support chats section */}\n            {privateSupportChannels.length > 0 && (\n              <div>\n                <div className=\"px-4 py-2 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  {language === 'ru' ? 'Обращения жителей' : 'Aholi murojatları'} ({privateSupportChannels.length})\n                </div>\n                <div className=\"divide-y\">\n                  {privateSupportChannels.map((channel) => {\n                    const isSelected = selectedChannelId === channel.id;\n\n                    return (\n                      <button\n                        key={channel.id}\n                        onClick={() => onSelectChannel(channel.id)}\n                        className={`w-full p-4 flex items-center gap-3 text-left hover:bg-gray-50 transition-colors ${\n                          isSelected ? 'bg-primary-50' : ''\n                        } ${channel.unread_count && channel.unread_count > 0 ? 'bg-blue-50/50' : ''}`}\n                      >\n                        <div className=\"relative\">\n                          <div className=\"w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-medium text-lg\">\n                            {/* Show first letter of name, fallback to 'U' for User if name is missing or starts with a number */}\n                            {channel.name && !/^\\d/.test(channel.name) ? channel.name.charAt(0).toUpperCase() : 'U'}\n                          </div>\n                          {channel.unread_count && channel.unread_count > 0 && (\n                            <div className=\"absolute -top-1 -right-1 min-w-5 h-5 bg-red-500 rounded-full flex items-center justify-center\">\n                              <span className=\"text-xs text-white font-medium px-1\">\n                                {channel.unread_count > 99 ? '99+' : channel.unread_count}\n                              </span>\n                            </div>\n                          )}\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center justify-between\">\n                            <span className={`truncate ${channel.unread_count && channel.unread_count > 0 ? 'font-semibold' : 'font-medium'}`}>\n                              {channel.name}\n                            </span>\n                            {channel.last_message_at && (\n                              <span className={`text-xs ${channel.unread_count && channel.unread_count > 0 ? 'text-blue-500 font-medium' : 'text-gray-400'}`}>\n                                {new Date(channel.last_message_at).toLocaleTimeString(language === 'ru' ? 'ru-RU' : 'uz-UZ', {\n                                  hour: '2-digit',\n                                  minute: '2-digit'\n                                })}\n                              </span>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            {channel.description && (\n                              <span className=\"text-xs text-gray-400\">\n                                {channel.description}\n                              </span>\n                            )}\n                            <span className={`text-sm truncate ${channel.unread_count && channel.unread_count > 0 ? 'text-gray-700 font-medium' : 'text-gray-500'}`}>\n                              {channel.last_message || ''}\n                            </span>\n                          </div>\n                        </div>\n                      </button>\n                    );\n                  })}\n                </div>\n              </div>\n            )}\n\n            {/* Group channels section */}\n            <div>\n              <div className=\"px-4 py-2 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                {language === 'ru' ? 'Групповые чаты' : 'Guruh chatlari'}\n              </div>\n              <div className=\"divide-y\">\n                {groupChannels.map((channel) => {\n                  const labels = CHAT_CHANNEL_LABELS[channel.type];\n                  const isSelected = selectedChannelId === channel.id;\n\n                  return (\n                    <button\n                      key={channel.id}\n                      onClick={() => onSelectChannel(channel.id)}\n                      className={`w-full p-4 flex items-center gap-3 text-left hover:bg-gray-50 transition-colors ${\n                        isSelected ? 'bg-primary-50' : ''\n                      }`}\n                    >\n                      <div className={`w-12 h-12 rounded-full flex items-center justify-center ${\n                        channel.type === 'uk_general' ? 'bg-purple-100 text-purple-600' : 'bg-green-100 text-green-600'\n                      }`}>\n                        {getChannelIcon(channel.type)}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"font-medium truncate\">\n                            {language === 'ru' ? labels.label : labels.labelUz}\n                          </span>\n                          {channel.last_message_at && (\n                            <span className=\"text-xs text-gray-400\">\n                              {new Date(channel.last_message_at).toLocaleTimeString(language === 'ru' ? 'ru-RU' : 'uz-UZ', {\n                                hour: '2-digit',\n                                minute: '2-digit'\n                              })}\n                            </span>\n                          )}\n                        </div>\n                        {channel.message_count && channel.message_count > 0 ? (\n                          <div className=\"flex items-center gap-2 text-sm text-gray-500\">\n                            <Users className=\"w-3.5 h-3.5\" />\n                            <span>{channel.message_count} {language === 'ru' ? 'сообщений' : 'xabar'}</span>\n                          </div>\n                        ) : (\n                          <p className=\"text-sm text-gray-400\">\n                            {language === 'ru' ? 'Нет сообщений' : 'Xabar yo\\'q'}\n                          </p>\n                        )}\n                      </div>\n                    </button>\n                  );\n                })}\n              </div>\n            </div>\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n\n// Chat view component - shared for all users\nfunction ChatView({\n  channelId,\n  channel,\n  onBack,\n  hideBackOnDesktop = false\n}: {\n  channelId: string;\n  channel?: ChatChannel;\n  onBack: () => void;\n  hideBackOnDesktop?: boolean;\n}) {\n  const { user } = useAuthStore();\n  const { language } = useLanguageStore();\n\n  const [messages, setMessages] = useState<ChatMessage[]>([]);\n  const [newMessage, setNewMessage] = useState('');\n  const [isLoading, setIsLoading] = useState(true);\n  const [isSending, setIsSending] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  // Fetch messages\n  const fetchMessages = useCallback(async () => {\n    // Skip if channelId is not valid\n    if (!channelId || channelId === 'undefined') {\n      console.warn('Invalid channelId, skipping message fetch');\n      setIsLoading(false);\n      return;\n    }\n    try {\n      const response = await chatApi.getMessages(channelId);\n      const messageList = response.messages || [];\n      setMessages(messageList);\n    } catch (error) {\n      console.error('Failed to fetch messages:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [channelId]);\n\n  // Mark channel as read when opening\n  const markAsRead = useCallback(async () => {\n    if (!channelId || channelId === 'undefined') return;\n    try {\n      await chatApi.markRead(channelId);\n    } catch (error) {\n      console.error('Failed to mark as read:', error);\n    }\n  }, [channelId]);\n\n  // Initial fetch and WebSocket subscription (no polling!)\n  useEffect(() => {\n    setIsLoading(true);\n    fetchMessages();\n\n    // Mark channel as read when opening\n    markAsRead();\n\n    // Subscribe to WebSocket chat messages instead of polling\n    const unsubscribe = subscribeToChatMessages((message) => {\n      // Only process messages for this channel\n      if (message.channel_id === channelId) {\n        console.log('[Chat] WebSocket message for this channel:', message);\n\n        // Handle read receipts\n        if (message.type === 'read') {\n          setMessages(prev => prev.map(m =>\n            m.id === message.message_id\n              ? { ...m, read_by: [...(m.read_by || []), message.user_id] }\n              : m\n          ));\n          return;\n        }\n\n        // Add new message if not already present\n        setMessages(prev => {\n          const exists = prev.some(m => m.id === message.id);\n          if (exists) return prev;\n          return [...prev, message];\n        });\n\n        // Auto-mark new messages as read since user is viewing\n        markAsRead();\n      }\n    });\n\n    return () => {\n      unsubscribe();\n    };\n  }, [fetchMessages, channelId, markAsRead]);\n\n  // Scroll to bottom on new messages - with slight delay to ensure DOM update\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n    }, 100);\n    return () => clearTimeout(timer);\n  }, [messages.length]);\n\n  const handleSend = async () => {\n    if (!newMessage.trim() || !user || isSending) return;\n\n    const messageToSend = newMessage.trim();\n    setNewMessage(''); // Clear immediately for better UX\n    setIsSending(true);\n\n    try {\n      const response = await chatApi.sendMessage(channelId, messageToSend);\n      // Add sent message to local state immediately (optimistic update)\n      if (response.message) {\n        setMessages(prev => {\n          const exists = prev.some(m => m.id === response.message.id);\n          if (exists) return prev;\n          return [...prev, response.message];\n        });\n      }\n    } catch (error) {\n      console.error('Failed to send message:', error);\n      // Restore message on error\n      setNewMessage(messageToSend);\n      alert('Не удалось отправить сообщение');\n    } finally {\n      setIsSending(false);\n    }\n  };\n\n  // Get channel title based on type\n  const getChannelTitle = () => {\n    if (channel?.type === 'private_support') {\n      // For residents - show \"Chat with administration\"\n      if (user?.role === 'resident') {\n        return language === 'ru' ? 'Чат с администрацией' : 'Administratsiya bilan chat';\n      }\n      // For admin/manager - show resident name\n      return channel.name || 'Чат';\n    }\n    if (channel) {\n      const labels = CHAT_CHANNEL_LABELS[channel.type];\n      return language === 'ru' ? labels.label : labels.labelUz;\n    }\n    return language === 'ru' ? 'Чат' : 'Chat';\n  };\n\n  const getChannelSubtitle = () => {\n    if (channel?.type === 'private_support') {\n      if (user?.role === 'resident') {\n        return language === 'ru' ? 'Личный чат' : 'Shaxsiy chat';\n      }\n      return channel.description || '';\n    }\n    return `${messages.length} ${language === 'ru' ? 'сообщений' : 'xabar'}`;\n  };\n\n  const isResidentView = user?.role === 'resident' && channel?.type === 'private_support';\n\n  return (\n    <div className=\"h-full flex flex-col bg-gray-50\">\n      {/* Header - compact for residents */}\n      <div className={`bg-white border-b flex items-center gap-3 ${isResidentView ? 'p-3' : 'p-4'}`}>\n        {!hideBackOnDesktop && (\n          <button\n            onClick={onBack}\n            className=\"p-2 hover:bg-gray-100 rounded-xl md:hidden\"\n          >\n            <ArrowLeft className=\"w-5 h-5\" />\n          </button>\n        )}\n        <div className={`rounded-full flex items-center justify-center ${\n          isResidentView ? 'w-8 h-8' : 'w-10 h-10'\n        } ${\n          channel?.type === 'private_support' ? 'bg-blue-100 text-blue-600' :\n          channel?.type === 'uk_general' ? 'bg-purple-100 text-purple-600' :\n          channel?.type === 'building_general' ? 'bg-green-100 text-green-600' :\n          channel?.type === 'entrance' ? 'bg-amber-100 text-amber-600' :\n          'bg-gray-100 text-gray-600'\n        }`}>\n          {channel?.type === 'private_support' ? (\n            user?.role === 'resident' ? <HeadphonesIcon className={isResidentView ? 'w-4 h-4' : 'w-5 h-5'} /> : <User className=\"w-5 h-5\" />\n          ) : (\n            <MessageCircle className=\"w-5 h-5\" />\n          )}\n        </div>\n        <div className=\"flex-1\">\n          <h3 className={`font-medium ${isResidentView ? 'text-sm' : ''}`}>{getChannelTitle()}</h3>\n          {!isResidentView && <p className=\"text-xs text-gray-500\">{getChannelSubtitle()}</p>}\n        </div>\n      </div>\n\n      {/* Messages */}\n      <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\n        {isLoading ? (\n          <div className=\"h-full flex items-center justify-center\">\n            <Loader2 className=\"w-8 h-8 animate-spin text-gray-400\" />\n          </div>\n        ) : messages.length === 0 ? (\n          <div className=\"h-full flex flex-col items-center justify-center text-center\">\n            <HeadphonesIcon className=\"w-10 h-10 text-gray-300 mb-3\" />\n            <p className=\"text-gray-400 text-sm\">\n              {language === 'ru' ? 'Напишите ваш вопрос' : 'Savolingizni yozing'}\n            </p>\n          </div>\n        ) : (\n          <>\n            {messages.map((message, index) => {\n              const isOwn = message.sender_id === user?.id;\n              const showAvatar = index === 0 ||\n                messages[index - 1].sender_id !== message.sender_id;\n              const showName = !isOwn && showAvatar;\n\n              return (\n                <div\n                  key={message.id}\n                  className={`flex ${isOwn ? 'justify-end' : 'justify-start'}`}\n                >\n                  <div className={`max-w-[80%] ${isOwn ? 'order-1' : ''}`}>\n                    {showName && (\n                      <div className=\"flex items-center gap-2 mb-1 px-2\">\n                        <span className=\"text-sm font-medium text-gray-700\">\n                          {message.sender_name}\n                        </span>\n                        <RoleBadge role={message.sender_role} language={language} />\n                      </div>\n                    )}\n                    <div className={`px-4 py-2 rounded-2xl ${\n                      isOwn\n                        ? 'bg-primary-500 text-gray-900 rounded-br-md'\n                        : 'bg-white text-gray-900 rounded-bl-md shadow-sm'\n                    }`}>\n                      <p className=\"text-sm whitespace-pre-wrap\">{message.content}</p>\n                      <div className={`flex items-center justify-end gap-1 mt-1 ${\n                        isOwn ? 'text-gray-700' : 'text-gray-400'\n                      }`}>\n                        <span className=\"text-[10px]\">\n                          {new Date(message.created_at).toLocaleTimeString(language === 'ru' ? 'ru-RU' : 'uz-UZ', {\n                            hour: '2-digit',\n                            minute: '2-digit'\n                          })}\n                        </span>\n                        {isOwn && (\n                          message.read_by && message.read_by.length > 1\n                            ? <CheckCheck className=\"w-3 h-3\" />\n                            : <Check className=\"w-3 h-3\" />\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n            <div ref={messagesEndRef} />\n          </>\n        )}\n      </div>\n\n      {/* Input */}\n      <div className={`bg-white border-t ${isResidentView ? 'p-3' : 'p-4'}`}>\n        <div className=\"flex items-center gap-2\">\n          <input\n            type=\"text\"\n            value={newMessage}\n            onChange={(e) => setNewMessage(e.target.value)}\n            onKeyDown={(e) => {\n              if (e.key === 'Enter' && !e.shiftKey) {\n                e.preventDefault();\n                handleSend();\n              }\n            }}\n            placeholder={language === 'ru' ? 'Написать...' : 'Yozing...'}\n            className={`flex-1 bg-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 ${\n              isResidentView ? 'px-3 py-2.5 text-sm' : 'px-4 py-3'\n            }`}\n            disabled={isSending}\n          />\n          <button\n            onClick={handleSend}\n            disabled={!newMessage.trim() || isSending}\n            className={`bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 rounded-xl transition-colors ${\n              isResidentView ? 'p-2.5' : 'p-3'\n            }`}\n          >\n            {isSending ? (\n              <Loader2 className={`text-gray-900 animate-spin ${isResidentView ? 'w-4 h-4' : 'w-5 h-5'}`} />\n            ) : (\n              <Send className={`text-gray-900 ${isResidentView ? 'w-4 h-4' : 'w-5 h-5'}`} />\n            )}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// Sound notification hook\nfunction useNotificationSound() {\n  const audioRef = useRef<HTMLAudioElement | null>(null);\n\n  useEffect(() => {\n    // Create audio element for notification sound\n    audioRef.current = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU' + btoa(String.fromCharCode.apply(null, Array(1000).fill(128).map((_, i) => Math.sin(i * 0.1) * 50 + 128))));\n    audioRef.current.volume = 0.3;\n  }, []);\n\n  const playSound = useCallback(() => {\n    if (audioRef.current) {\n      audioRef.current.currentTime = 0;\n      audioRef.current.play().catch(() => {});\n    }\n  }, []);\n\n  return playSound;\n}\n\n// Main Chat Page\nexport function ChatPage() {\n  const { user } = useAuthStore();\n  const { language } = useLanguageStore();\n  const [channels, setChannels] = useState<ChatChannel[]>([]);\n  const [selectedChannelId, setSelectedChannelId] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [residentChannel, setResidentChannel] = useState<ChatChannel | null>(null);\n  const prevUnreadRef = useRef<number>(0);\n  const playSound = useNotificationSound();\n\n  const isResident = user?.role === 'resident';\n\n  // Fetch channels with polling\n  const fetchChannels = useCallback(async () => {\n    try {\n      setError(null);\n      if (isResident) {\n        const channel = await chatApi.getOrCreateSupportChannel();\n        if (channel && channel.id) {\n          setResidentChannel(channel);\n        } else {\n          setError(language === 'ru' ? 'Не удалось создать чат' : 'Chat yaratib bo\\'lmadi');\n        }\n      } else {\n        const response = await chatApi.getChannels();\n        const newChannels = response.channels || [];\n\n        // Calculate total unread\n        const totalUnread = newChannels.reduce((sum: number, ch: ChatChannel) => sum + (ch.unread_count || 0), 0);\n\n        // Play sound if new messages arrived\n        if (totalUnread > prevUnreadRef.current && prevUnreadRef.current > 0) {\n          playSound();\n        }\n        prevUnreadRef.current = totalUnread;\n\n        setChannels(newChannels);\n      }\n    } catch (err) {\n      console.error('Failed to fetch channels:', err);\n      setError(language === 'ru' ? 'Ошибка загрузки' : 'Yuklanmadi');\n    }\n  }, [isResident, playSound, language]);\n\n  // Initial fetch\n  useEffect(() => {\n    setIsLoading(true);\n    fetchChannels().finally(() => setIsLoading(false));\n  }, [fetchChannels]);\n\n  // Poll for channel updates every 5 seconds\n  useEffect(() => {\n    if (isResident) return;\n\n    const interval = setInterval(fetchChannels, 5000);\n    return () => clearInterval(interval);\n  }, [fetchChannels, isResident]);\n\n  // Find selected channel\n  const selectedChannel = channels.find(ch => ch.id === selectedChannelId);\n\n  // If resident and has channel, show compact chat card\n  if (isResident) {\n    if (isLoading) {\n      return (\n        <div className=\"max-w-lg mx-auto\">\n          <div className=\"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex items-center justify-center\">\n            <Loader2 className=\"w-8 h-8 animate-spin text-gray-400\" />\n          </div>\n        </div>\n      );\n    }\n\n    if (residentChannel) {\n      return (\n        <div className=\"max-w-lg mx-auto\">\n          <div className=\"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex flex-col\">\n            <ChatView\n              channelId={residentChannel.id}\n              channel={residentChannel}\n              onBack={() => window.history.back()}\n              hideBackOnDesktop\n            />\n          </div>\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"max-w-lg mx-auto\">\n        <div className=\"bg-white rounded-2xl shadow-sm border overflow-hidden h-[70vh] md:h-[65vh] flex flex-col items-center justify-center gap-4 p-6\">\n          <AlertCircle className=\"w-12 h-12 text-red-400\" />\n          <p className=\"text-gray-500 text-center\">{error || (language === 'ru' ? 'Ошибка загрузки чата' : 'Chat yuklanmadi')}</p>\n          <button\n            onClick={() => {\n              setIsLoading(true);\n              setError(null);\n              fetchChannels().finally(() => setIsLoading(false));\n            }}\n            className=\"px-4 py-2 bg-primary-500 text-gray-900 rounded-xl hover:bg-primary-600 transition-colors\"\n          >\n            {language === 'ru' ? 'Повторить' : 'Qayta urinish'}\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  // For admin/manager - show channel list with chat view\n  return (\n    <div className=\"h-[calc(100vh-180px)] md:h-[calc(100vh-140px)] bg-white rounded-2xl shadow-sm border overflow-hidden\">\n      <div className=\"h-full flex\">\n        {/* Channel list - always visible on desktop, hidden when chat selected on mobile */}\n        <div className={`${\n          selectedChannelId ? 'hidden md:block' : 'block'\n        } w-full md:w-80 lg:w-96 border-r bg-white/80 backdrop-blur-sm`}>\n          <AdminChannelList\n            channels={channels}\n            onSelectChannel={setSelectedChannelId}\n            selectedChannelId={selectedChannelId}\n            isLoading={isLoading}\n          />\n        </div>\n\n        {/* Chat view - shown when channel selected */}\n        <div className={`${\n          selectedChannelId ? 'block' : 'hidden md:flex'\n        } flex-1 bg-gray-50/50`}>\n          {selectedChannelId ? (\n            <ChatView\n              channelId={selectedChannelId}\n              channel={selectedChannel}\n              onBack={() => setSelectedChannelId(null)}\n            />\n          ) : (\n            <div className=\"h-full flex items-center justify-center\">\n              <div className=\"text-center\">\n                <div className=\"w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center\">\n                  <MessageCircle className=\"w-10 h-10 text-gray-400\" />\n                </div>\n                <p className=\"text-gray-500\">\n                  {language === 'ru' ? 'Выберите чат для просмотра' : 'Ko\\'rish uchun chatni tanlang'}\n                </p>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":["RoleBadge","role","language","roleConfig","jsx","Shield","Crown","Wrench","User","Building2","config","AdminChannelList","channels","onSelectChannel","selectedChannelId","isLoading","useLanguageStore","searchQuery","setSearchQuery","useState","filteredChannels","ch","query","sortByUnread","a","b","aUnread","bUnread","aTime","privateSupportChannels","groupChannels","totalUnread","sum","getChannelIcon","type","Users","MessageCircle","jsxs","Search","e","Loader2","Fragment","channel","isSelected","labels","CHAT_CHANNEL_LABELS","ChatView","channelId","onBack","hideBackOnDesktop","user","useAuthStore","messages","setMessages","newMessage","setNewMessage","setIsLoading","isSending","setIsSending","messagesEndRef","useRef","fetchMessages","useCallback","messageList","chatApi","markAsRead","useEffect","unsubscribe","subscribeToChatMessages","message","prev","m","timer","handleSend","messageToSend","response","getChannelTitle","getChannelSubtitle","isResidentView","ArrowLeft","HeadphonesIcon","index","isOwn","showAvatar","showName","CheckCheck","Check","Send","useNotificationSound","audioRef","_","i","ChatPage","setChannels","setSelectedChannelId","error","setError","residentChannel","setResidentChannel","prevUnreadRef","playSound","isResident","fetchChannels","newChannels","interval","selectedChannel","AlertCircle"],"mappings":"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"}