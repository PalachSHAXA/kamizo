import{r as l,j as e,$ as me,K as xe,U as I,l as he,F as ue,ad as ge,B as J,aB as pe,D as Q,y as je,O as fe}from"./react-vendor-1769428875114-t_MJ7TI5.js";import{b as V,u as Ne,F as be,j as ve,x as ye}from"./index-1769428875114-CG_16j_e.js";import"./vendor-1769428875114-wOrLRiCI.js";import"./qr-scanner-1769428875114-B_vB3SDT.js";import"./zustand-1769428875114-wNUYBKDB.js";function Re(){const{user:W}=V(),{rentalApartments:f,rentalRecords:X,addRentalApartment:Y,deleteRentalApartment:ee,addRentalRecord:se,deleteRentalRecord:te,fetchRentals:L}=Ne(),[ae,B]=l.useState(!0);l.useEffect(()=>{(async()=>{B(!0);try{await L()}catch{}finally{B(!1)}})()},[L]);const[v,y]=l.useState(!1),[ne,w]=l.useState(!1),[h,k]=l.useState(null),[S,P]=l.useState(null),[g,C]=l.useState(null),[O,D]=l.useState(""),[U,p]=l.useState(""),[r,x]=l.useState({name:"",address:"",apartment:"",ownerName:"",ownerPhone:"",ownerLogin:"",password:"",ownerType:"tenant"}),[T,E]=l.useState([]),[N,A]=l.useState([]),[M,j]=l.useState([]),[o,F]=l.useState(""),[c,b]=l.useState(""),[i,u]=l.useState(null),[$,_]=l.useState(!1),[z,Z]=l.useState(!1),[K,G]=l.useState(!1);l.useEffect(()=>{if(!v)return;(async()=>{_(!0);try{const t=await be.getAll();E(t.branches||[])}catch{}finally{_(!1)}})()},[v]),l.useEffect(()=>{if(!o){A([]),b(""),j([]),u(null);return}(async()=>{Z(!0),b(""),j([]),u(null);try{const a=((await ve.getAll()).buildings||[]).filter(d=>d.branch_code===o);A(a)}catch{}finally{Z(!1)}})()},[o]),l.useEffect(()=>{if(!c){j([]),u(null);return}(async()=>{G(!0),u(null);try{const t=await ye.getAll({role:"resident",building_id:c,limit:500});j(t.users||[])}catch{}finally{G(!1)}})()},[c]);const le=s=>{const t=M.find(a=>a.id===s);if(u(t||null),t){const a=N.find(d=>d.id===c);x(d=>({...d,address:a?.address||t.address||"",apartment:t.apartment||"",ownerName:t.name||"",ownerPhone:t.phone||"",ownerLogin:t.login||""}))}},q=()=>{F(""),b(""),u(null),E([]),A([]),j([])},[n,m]=l.useState({guestNames:"",passportInfo:"",checkInDate:"",checkOutDate:"",amount:"",currency:"UZS",notes:""}),re=()=>{const t=(r.ownerType==="commercial_owner"?"owner":"tenant")+Math.floor(Math.random()*1e4),a=Math.random().toString(36).slice(-8);x({...r,ownerLogin:t,password:a})},ce=async()=>{if(!g)return;const s=f.find(t=>t.id===g.id);if(!s||s.ownerPassword!==O){p("Неверный пароль");return}try{await ee(g.id);const{removeUser:t}=V.getState();t(g.ownerLogin),C(null),D(""),p("")}catch{p("Ошибка удаления")}},ie=async()=>{if(!r.name||!i||!r.ownerLogin||!r.password){alert("Пожалуйста, заполните все обязательные поля");return}const t=(r.ownerType==="commercial_owner"?"owner_":"tenant_")+Math.random().toString(36).substr(2,9);try{await Y({...r,ownerId:t,password:r.password,ownerType:r.ownerType})?(P({login:r.ownerLogin,password:r.password}),x({name:"",address:"",apartment:"",ownerName:"",ownerPhone:"",ownerLogin:"",password:"",ownerType:"tenant"}),q(),y(!1)):alert("Ошибка создания пользователя. Ответ сервера пустой.")}catch(a){alert(`Ошибка создания пользователя: ${a.message||"Неизвестная ошибка"}`)}},de=async()=>{if(!h||!n.guestNames||!n.passportInfo||!n.checkInDate||!n.checkOutDate||!n.amount)return;await se({apartmentId:h,guestNames:n.guestNames,passportInfo:n.passportInfo,checkInDate:n.checkInDate,checkOutDate:n.checkOutDate,amount:parseFloat(n.amount),currency:n.currency,notes:n.notes,createdBy:W?.id||""})?(m({guestNames:"",passportInfo:"",checkInDate:"",checkOutDate:"",amount:"",currency:"UZS",notes:""}),w(!1)):alert("Ошибка сохранения записи")},H=s=>X.filter(t=>t.apartmentId===s).sort((t,a)=>new Date(a.checkInDate).getTime()-new Date(t.checkInDate).getTime()),R=s=>new Date(s).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric"}),oe=(s,t)=>t==="UZS"?s.toLocaleString("ru-RU")+" сум":"$"+s.toLocaleString("en-US");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Аренда квартир"}),e.jsx("button",{onClick:()=>y(!0),className:"btn-primary",children:"+ Добавить квартиру"})]}),ae?e.jsxs("div",{className:"glass-card p-8 text-center",children:[e.jsx(me,{className:"w-12 h-12 text-primary-500 mx-auto mb-4 animate-spin"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Загрузка..."})]}):f.length===0?e.jsxs("div",{className:"glass-card p-8 text-center",children:[e.jsx(xe,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Квартир пока нет"}),e.jsx("p",{className:"text-gray-500",children:"Добавьте первую квартиру для управления арендой"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:f.map(s=>{const t=H(s.id),a=t.find(d=>new Date(d.checkOutDate)>=new Date);return e.jsxs("div",{className:"glass-card p-5 cursor-pointer hover:shadow-lg transition-shadow",onClick:()=>k(s.id),children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg mb-1",children:s.name}),e.jsxs("div",{className:"text-sm text-gray-500",children:[s.address,", кв. ",s.apartment]})]}),a?e.jsx("span",{className:"badge badge-progress",children:"Занята"}):e.jsx("span",{className:"badge badge-done",children:"Свободна"})]}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4"}),s.ownerName]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{className:"w-4 h-4"}),s.ownerPhone]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"}),t.length," записей"]})]}),a&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Текущий гость:"}),e.jsx("div",{className:"text-sm font-medium",children:a.guestNames}),e.jsxs("div",{className:"text-xs text-gray-500",children:["до ",R(a.checkOutDate)]})]}),e.jsx("button",{onClick:d=>{d.stopPropagation(),C({id:s.id,ownerLogin:s.ownerLogin})},className:"mt-3 text-xs text-red-500 hover:text-red-700",children:"Удалить квартиру"})]},s.id)})}),h&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",onClick:()=>k(null),children:e.jsx("div",{className:"bg-white rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto",onClick:s=>s.stopPropagation(),children:(()=>{const s=f.find(a=>a.id===h),t=H(h);return s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:s.name}),e.jsxs("div",{className:"text-gray-500",children:[s.address,", кв. ",s.apartment]})]}),e.jsx("button",{onClick:()=>{w(!0)},className:"btn-primary text-sm",children:"+ Добавить запись"})]}),e.jsxs("div",{className:"mb-6 p-4 bg-gray-50 rounded-xl",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-2",children:"Владелец"}),e.jsx("div",{className:"font-medium",children:s.ownerName}),e.jsx("div",{className:"text-sm text-gray-600",children:s.ownerPhone}),e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Логин"}),e.jsx("div",{className:"font-mono text-sm font-medium text-gray-700",children:s.ownerLogin})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Пароль"}),e.jsx("div",{className:"font-mono text-sm font-medium text-gray-700",children:s.ownerPassword||"—"})]})]})})]}),e.jsxs("h3",{className:"font-semibold mb-4",children:["История аренды (",t.length,")"]}),t.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Записей пока нет"}):e.jsx("div",{className:"space-y-3",children:t.map(a=>{const d=new Date(a.checkOutDate)>=new Date;return e.jsxs("div",{className:`p-4 rounded-xl border ${d?"border-green-200 bg-green-50":"border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.guestNames}),e.jsx("div",{className:"text-sm text-gray-500",children:a.passportInfo})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold text-green-600",children:oe(a.amount,a.currency)}),d&&e.jsx("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded",children:"Активно"})]})]}),e.jsx("div",{className:"flex items-center gap-4 mt-2 text-sm text-gray-600",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ge,{className:"w-4 h-4"}),R(a.checkInDate)," - ",R(a.checkOutDate)]})}),a.notes&&e.jsx("div",{className:"mt-2 text-sm text-gray-500",children:a.notes}),e.jsx("button",{onClick:async()=>{try{await te(a.id)}catch{alert("Ошибка удаления записи")}},className:"mt-2 text-xs text-red-500 hover:text-red-700",children:"Удалить"})]},a.id)})}),e.jsx("div",{className:"flex justify-end mt-6",children:e.jsx("button",{onClick:()=>k(null),className:"btn-secondary",children:"Закрыть"})})]}):null})()})}),v&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx("h2",{className:"text-xl font-bold mb-6",children:"Добавить квартиру"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Название"}),e.jsx("input",{type:"text",value:r.name,onChange:s=>x({...r,name:s.target.value}),placeholder:"Квартира у моря",className:"glass-input"})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("h3",{className:"font-medium mb-3 flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5"}),"Выбор квартиры и владельца"]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-1",children:[e.jsx(pe,{className:"w-4 h-4"}),"Филиал *"]}),e.jsxs("select",{value:o,onChange:s=>F(s.target.value),className:"glass-input w-full",disabled:$,children:[e.jsx("option",{value:"",children:$?"Загрузка...":"Выберите филиал"}),T.map(s=>e.jsx("option",{value:s.code,children:s.name},s.code))]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-1",children:[e.jsx(J,{className:"w-4 h-4"}),"Дом *"]}),e.jsxs("select",{value:c,onChange:s=>b(s.target.value),className:"glass-input w-full",disabled:!o||z,children:[e.jsx("option",{value:"",children:z?"Загрузка...":o?"Выберите дом":"Сначала выберите филиал"}),N.map(s=>e.jsxs("option",{value:s.id,children:[s.name," - ",s.address]},s.id))]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-1",children:[e.jsx(I,{className:"w-4 h-4"}),"Житель (владелец) *"]}),e.jsxs("select",{value:i?.id||"",onChange:s=>le(s.target.value),className:"glass-input w-full",disabled:!c||K,children:[e.jsx("option",{value:"",children:K?"Загрузка...":c?"Выберите жителя":"Сначала выберите дом"}),M.map(s=>e.jsxs("option",{value:s.id,children:[s.name," ",s.apartment?`- кв. ${s.apartment}`:""]},s.id))]})]}),i&&e.jsx("div",{className:"bg-primary-50 border border-primary-200 rounded-xl p-4 mt-3",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center",children:e.jsx(I,{className:"w-5 h-5 text-primary-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:i.name}),e.jsx("p",{className:"text-sm text-gray-600",children:i.phone||"Телефон не указан"}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:[N.find(s=>s.id===c)?.address,i.apartment&&`, кв. ${i.apartment}`]})]})]})}),(o||c)&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500 mt-2 flex-wrap",children:[o&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"bg-gray-100 px-2 py-1 rounded",children:T.find(s=>s.code===o)?.name}),c&&e.jsx(Q,{className:"w-3 h-3"})]}),c&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"bg-gray-100 px-2 py-1 rounded",children:N.find(s=>s.id===c)?.name}),i&&e.jsx(Q,{className:"w-3 h-3"})]}),i&&e.jsx("span",{className:"bg-primary-100 text-primary-700 px-2 py-1 rounded",children:i.name})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h3",{className:"font-medium mb-3",children:"Учётные данные владельца"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Логин"}),e.jsx("input",{type:"text",value:r.ownerLogin,onChange:s=>x({...r,ownerLogin:s.target.value}),className:"glass-input",readOnly:!!i?.login})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Пароль"}),e.jsx("input",{type:"text",value:r.password,onChange:s=>x({...r,password:s.target.value}),className:"glass-input"})]})]}),e.jsx("button",{onClick:re,className:"text-sm text-primary-600 hover:text-primary-700",children:"Сгенерировать логин/пароль"})]})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{onClick:()=>{y(!1),q(),x({name:"",address:"",apartment:"",ownerName:"",ownerPhone:"",ownerLogin:"",password:"",ownerType:"tenant"})},className:"btn-secondary flex-1",children:"Отмена"}),e.jsx("button",{onClick:ie,className:"btn-primary flex-1",disabled:!i,children:"Добавить"})]})]})}),ne&&h&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-full max-w-md",children:[e.jsx("h2",{className:"text-xl font-bold mb-6",children:"Добавить запись"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Имена гостей"}),e.jsx("input",{type:"text",value:n.guestNames,onChange:s=>m({...n,guestNames:s.target.value}),placeholder:"Иванов Иван, Петрова Мария",className:"glass-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Паспортные данные"}),e.jsx("input",{type:"text",value:n.passportInfo,onChange:s=>m({...n,passportInfo:s.target.value}),placeholder:"AA1234567",className:"glass-input"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Дата заезда"}),e.jsx("input",{type:"date",value:n.checkInDate,onChange:s=>m({...n,checkInDate:s.target.value}),className:"glass-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Дата выезда"}),e.jsx("input",{type:"date",value:n.checkOutDate,onChange:s=>m({...n,checkOutDate:s.target.value}),className:"glass-input"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Сумма"}),e.jsx("input",{type:"number",value:n.amount,onChange:s=>m({...n,amount:s.target.value}),placeholder:"1000000",className:"glass-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Валюта"}),e.jsxs("select",{value:n.currency,onChange:s=>m({...n,currency:s.target.value}),className:"glass-input",children:[e.jsx("option",{value:"UZS",children:"UZS (сум)"}),e.jsx("option",{value:"USD",children:"USD ($)"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Заметки (опционально)"}),e.jsx("textarea",{value:n.notes,onChange:s=>m({...n,notes:s.target.value}),className:"glass-input min-h-[80px]",placeholder:"Дополнительная информация..."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{onClick:()=>{w(!1)},className:"btn-secondary flex-1",children:"Отмена"}),e.jsx("button",{onClick:de,className:"btn-primary flex-1",children:"Добавить"})]})]})}),S&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-full max-w-sm text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(je,{className:"w-8 h-8 text-green-600"})}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Квартира добавлена!"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"Данные для входа владельца:"}),e.jsxs("div",{className:"bg-gray-50 rounded-xl p-4 mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-gray-500",children:"Логин:"}),e.jsx("span",{className:"font-mono font-bold",children:S.login})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-500",children:"Пароль:"}),e.jsx("span",{className:"font-mono font-bold",children:S.password})]})]}),e.jsx("button",{onClick:()=>P(null),className:"btn-primary w-full",children:"Готово"})]})}),g&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-full max-w-sm",children:[e.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(fe,{className:"w-8 h-8 text-red-600"})}),e.jsx("h2",{className:"text-xl font-bold mb-2 text-center",children:"Подтвердите удаление"}),e.jsx("p",{className:"text-gray-500 mb-6 text-center",children:"Введите пароль владельца квартиры для подтверждения удаления"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("input",{type:"password",value:O,onChange:s=>{D(s.target.value),p("")},placeholder:"Пароль владельца",className:"glass-input w-full"}),U&&e.jsx("p",{className:"text-red-500 text-sm mt-2",children:U})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{C(null),D(""),p("")},className:"btn-secondary flex-1",children:"Отмена"}),e.jsx("button",{onClick:ce,className:"flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-medium transition-colors",children:"Удалить"})]})]})})]})}export{Re as RentalsPage};
//# sourceMappingURL=RentalsPage-1769428875114-CPqVMfF_.js.map
