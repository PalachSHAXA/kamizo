import{b as J,u as W,d as ee,_ as se,v as p}from"./index-1768936274458-DQj4Cu1o.js";import{r as n,j as e,at as ae,X as E,Q as te,aR as re,aY as ne,y as S,J as B,am as T,l as H,f as z,ab as ie,A as le,U as ce,h as de,q as oe}from"./react-vendor-1768936274458-rd3wd0Us.js";import"./zustand-1768936274458-wNUYBKDB.js";import"./vendor-1768936274458-BnsfpFWz.js";import"./qr-scanner-1768936274458-cr32YHjo.js";function be(){const{user:c}=J(),{validateGuestAccessCode:I,useGuestAccessCode:M,addGuestAccessLog:m,getGuestAccessLogs:F,guestAccessCodes:x}=W(),{language:t}=ee();n.useEffect(()=>{x.forEach(a=>{})},[x]);const[K,v]=n.useState(!1),[j,N]=n.useState(!1),[s,o]=n.useState(null),[L,w]=n.useState(!1),[h,P]=n.useState(""),[g,Q]=n.useState(!1),[D,k]=n.useState(null),d=n.useRef(null),R=n.useRef(null),b=n.useRef(null),u=n.useRef(null),f=n.useRef(!1),q=F().slice(0,20),C=n.useCallback(a=>{const r=I(a);if(r.valid)o({status:"success",code:r.code,message:t==="ru"?"Пропуск действителен":"Ruxsatnoma amal qiladi"});else{let i="",l="invalid";switch(r.error){case"expired":l="expired",i=t==="ru"?"Пропуск истёк":"Ruxsatnoma muddati tugagan";break;case"revoked":l="revoked",i=t==="ru"?"Пропуск отменён":"Ruxsatnoma bekor qilingan";break;case"already_used":case"max_uses_reached":l="used",i=t==="ru"?"Пропуск уже использован":"Ruxsatnoma ishlatilgan";break;case"not_yet_valid":l="not_yet_valid",i=t==="ru"?"Пропуск ещё не действителен":"Ruxsatnoma hali amal qilmaydi";break;default:l="invalid",i=t==="ru"?"Недействительный QR-код":"Noto'g'ri QR-kod"}o({status:l,code:r.code,message:i}),c&&r.code&&m({accessCodeId:r.code.id,scannedById:c.id,scannedByName:c.name,scannedByRole:c.role,action:l==="expired"?"scan_expired":l==="used"?"scan_used":l==="revoked"?"scan_revoked":"scan_invalid",visitorType:r.code.visitorType,residentName:r.code.residentName,residentApartment:r.code.residentApartment})}},[I,m,c,t]),A=n.useCallback(async()=>{if(!f.current||!d.current||!R.current)return;const a=d.current,r=R.current,i=r.getContext("2d");if(!i||a.readyState!==a.HAVE_ENOUGH_DATA){u.current=requestAnimationFrame(()=>{A()});return}r.width=a.videoWidth,r.height=a.videoHeight,i.drawImage(a,0,0,r.width,r.height);try{const l=i.getImageData(0,0,r.width,r.height),{default:$}=await se(async()=>{const{default:X}=await import("./qr-scanner-1768936274458-cr32YHjo.js").then(Z=>Z.j);return{default:X}},[]),_=$(l.data,l.width,l.height,{inversionAttempts:"dontInvert"});if(_&&_.data){f.current=!1,C(_.data),y();return}}catch{}u.current=requestAnimationFrame(()=>{A()})},[C]),G=async()=>{try{if(k(null),v(!0),N(!1),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not supported");let a;try{a=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}}})}catch{a=await navigator.mediaDevices.getUserMedia({video:!0})}if(b.current=a,d.current){d.current.srcObject=a;const r=async()=>{try{d.current&&(await d.current.play(),N(!0),f.current=!0,A())}catch{k(t==="ru"?"Не удалось запустить видео. Нажмите на экран.":"Video ishga tushmadi. Ekranga bosing.")}};d.current.onloadedmetadata=()=>{r()},d.current.oncanplay=()=>{j||r()}}}catch(a){v(!1);let r=t==="ru"?"Не удалось получить доступ к камере.":"Kameraga kirish imkoni bo'lmadi.";a instanceof Error&&(a.name==="NotAllowedError"||a.name==="PermissionDeniedError"?r=t==="ru"?"Доступ к камере запрещён. Разрешите доступ в настройках браузера.":"Kameraga ruxsat berilmagan. Brauzer sozlamalarida ruxsat bering.":a.name==="NotFoundError"||a.name==="DevicesNotFoundError"?r=t==="ru"?"Камера не найдена на устройстве.":"Qurilmada kamera topilmadi.":a.name==="NotReadableError"||a.name==="TrackStartError"?r=t==="ru"?"Камера используется другим приложением.":"Kamera boshqa dastur tomonidan ishlatilmoqda.":a.message==="Camera API not supported"&&(r=t==="ru"?"Камера не поддерживается. Убедитесь, что используете HTTPS.":"Kamera qo'llab-quvvatlanmaydi. HTTPS ishlatilayotganiga ishonch hosil qiling.")),k(r)}},y=n.useCallback(()=>{f.current=!1,u.current&&(cancelAnimationFrame(u.current),u.current=null),b.current&&(b.current.getTracks().forEach(a=>a.stop()),b.current=null),d.current&&(d.current.srcObject=null),v(!1),N(!1)},[]);n.useEffect(()=>()=>{y()},[y]);const V=()=>{!s?.code||!c||(M(s.code.id,s.code),m({accessCodeId:s.code.id,scannedById:c.id,scannedByName:c.name,scannedByRole:c.role,action:"entry_allowed",visitorType:s.code.visitorType,residentName:s.code.residentName,residentApartment:s.code.residentApartment}),o(null))},O=()=>{!s?.code||!c||(m({accessCodeId:s.code.id,scannedById:c.id,scannedByName:c.name,scannedByRole:c.role,action:"entry_denied",visitorType:s.code.visitorType,residentName:s.code.residentName,residentApartment:s.code.residentApartment}),o(null))},U=()=>{h.trim()&&(C(h.trim()),P(""),w(!1))},Y=a=>{switch(a){case"courier":return e.jsx(oe,{className:"w-6 h-6"});case"guest":return e.jsx(de,{className:"w-6 h-6"});case"taxi":return e.jsx(z,{className:"w-6 h-6"});default:return e.jsx(ce,{className:"w-6 h-6"})}};return e.jsxs("div",{className:"space-y-4 md:space-y-6 pb-20 md:pb-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold text-gray-900",children:t==="ru"?"Сканер QR":"QR skaner"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:t==="ru"?"Сканируйте пропуска посетителей":"Tashrif buyuruvchilar ruxsatnomalarini skanerlang"}),e.jsxs("p",{className:"text-xs text-blue-500 mt-1",children:[t==="ru"?"Активных пропусков":"Faol ruxsatnomalar",": ",x.filter(a=>a.status==="active").length," / ",x.length]})]}),e.jsx("button",{onClick:()=>Q(!g),className:`p-2.5 rounded-xl transition-colors ${g?"bg-primary-500 text-gray-900":"bg-white/50 text-gray-600 hover:bg-white"}`,children:e.jsx(ae,{className:"w-5 h-5"})})]}),!g&&!s&&e.jsx("div",{className:"glass-card overflow-hidden",children:K?e.jsxs("div",{className:"relative bg-black",style:{minHeight:"300px"},children:[e.jsx("video",{ref:d,className:"w-full h-auto",style:{minHeight:"300px",maxHeight:"70vh",objectFit:"cover"},playsInline:!0,muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:R,className:"hidden"}),!j&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-900",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"w-12 h-12 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{children:t==="ru"?"Загрузка камеры...":"Kamera yuklanmoqda..."})]})}),j&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsxs("div",{className:"w-64 h-64 border-2 border-white/50 rounded-2xl relative",children:[e.jsx("div",{className:"absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-primary-500 rounded-tl-xl"}),e.jsx("div",{className:"absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-primary-500 rounded-tr-xl"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-primary-500 rounded-bl-xl"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-primary-500 rounded-br-xl"}),e.jsx("div",{className:"absolute inset-x-2 h-0.5 bg-primary-500 animate-bounce",style:{top:"50%"}})]})}),e.jsxs("button",{onClick:y,className:"absolute bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-medium rounded-xl flex items-center gap-2 z-10",children:[e.jsx(E,{className:"w-5 h-5"}),t==="ru"?"Остановить":"To'xtatish"]})]}):e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"w-24 h-24 mx-auto mb-6 bg-primary-100 rounded-full flex items-center justify-center",children:e.jsx(te,{className:"w-12 h-12 text-primary-600"})}),D?e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"text-red-500 mb-2",children:D}),e.jsx("p",{className:"text-sm text-gray-500",children:t==="ru"?"Попробуйте снова или используйте ручной ввод кода":"Qayta urinib ko'ring yoki qo'lda kod kiriting"})]}):e.jsx("p",{className:"text-gray-600 mb-6",children:t==="ru"?"Нажмите кнопку, чтобы начать сканирование":"Skanerlashni boshlash uchun tugmani bosing"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:[e.jsxs("button",{onClick:G,className:"px-6 py-4 bg-primary-500 hover:bg-primary-600 text-gray-900 font-bold rounded-xl flex items-center justify-center gap-2",children:[e.jsx(re,{className:"w-5 h-5"}),t==="ru"?"Сканировать QR":"QR skanerlash"]}),e.jsxs("button",{onClick:()=>w(!0),className:"px-6 py-4 border-2 border-gray-200 hover:border-gray-300 rounded-xl font-medium flex items-center justify-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5"}),t==="ru"?"Ввести код":"Kod kiriting"]})]})]})}),L&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold",children:t==="ru"?"Ввод кода":"Kod kiriting"}),e.jsx("button",{onClick:()=>w(!1),className:"p-2 hover:bg-gray-100 rounded-xl",children:e.jsx(E,{className:"w-5 h-5"})})]}),e.jsx("input",{type:"text",value:h,onChange:a=>P(a.target.value),placeholder:"GA-xxxxx-xxxxx-xxxxx",className:"w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary-500 focus:ring-0 mb-4 font-mono",autoFocus:!0,onKeyDown:a=>a.key==="Enter"&&U()}),e.jsx("button",{onClick:U,disabled:!h.trim(),className:"w-full py-3 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 text-gray-900 font-bold rounded-xl",children:t==="ru"?"Проверить":"Tekshirish"})]})}),s&&e.jsxs("div",{className:"glass-card overflow-hidden",children:[e.jsxs("div",{className:`p-6 text-center ${s.status==="success"?"bg-green-500":s.status==="expired"||s.status==="used"?"bg-amber-500":"bg-red-500"}`,children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-4 bg-white/20 rounded-full flex items-center justify-center",children:s.status==="success"?e.jsx(S,{className:"w-10 h-10 text-white"}):s.status==="expired"||s.status==="used"||s.status==="not_yet_valid"?e.jsx(B,{className:"w-10 h-10 text-white"}):e.jsx(T,{className:"w-10 h-10 text-white"})}),e.jsx("h2",{className:"text-xl font-bold text-white mb-1",children:s.message}),s.code&&e.jsxs("p",{className:"text-white/80",children:[p[s.code.visitorType].icon," ",t==="ru"?p[s.code.visitorType].label:p[s.code.visitorType].labelUz]})]}),s.code&&e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4 bg-gray-50 rounded-xl",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600",children:Y(s.code.visitorType)}),e.jsxs("div",{className:"flex-1",children:[s.code.visitorName&&e.jsx("div",{className:"font-medium text-lg",children:s.code.visitorName}),s.code.visitorPhone&&e.jsxs("div",{className:"text-gray-500 flex items-center gap-1",children:[e.jsx(H,{className:"w-4 h-4"}),s.code.visitorPhone]}),s.code.visitorVehiclePlate&&e.jsxs("div",{className:"text-gray-500 flex items-center gap-1",children:[e.jsx(z,{className:"w-4 h-4"}),s.code.visitorVehiclePlate]})]})]}),e.jsxs("div",{className:"p-4 border-2 border-gray-100 rounded-xl",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-2",children:t==="ru"?"Идёт к жителю":"Quyidagi turar joy egasiga"}),e.jsx("div",{className:"font-medium text-lg",children:s.code.residentName}),e.jsxs("div",{className:"text-gray-600 flex items-center gap-1 mt-1",children:[e.jsx(ie,{className:"w-4 h-4"}),s.code.residentAddress,", ",t==="ru"?"кв.":"xona"," ",s.code.residentApartment]}),e.jsxs("div",{className:"text-gray-500 flex items-center gap-1 mt-1",children:[e.jsx(H,{className:"w-4 h-4"}),s.code.residentPhone]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(le,{className:"w-4 h-4"}),t==="ru"?"Действует до":"Gacha amal qiladi",":"," ",new Date(s.code.validUntil).toLocaleString(t==="ru"?"ru-RU":"uz-UZ")]}),s.code.notes&&e.jsxs("div",{className:"p-3 bg-blue-50 rounded-xl text-sm text-blue-700",children:[e.jsxs("strong",{children:[t==="ru"?"Примечание":"Izoh",":"]})," ",s.code.notes]}),s.status==="success"?e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsxs("button",{onClick:O,className:"flex-1 py-4 border-2 border-red-200 text-red-600 hover:bg-red-50 rounded-xl font-bold flex items-center justify-center gap-2",children:[e.jsx(T,{className:"w-5 h-5"}),t==="ru"?"Отказать":"Rad etish"]}),e.jsxs("button",{onClick:V,className:"flex-1 py-4 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold flex items-center justify-center gap-2",children:[e.jsx(S,{className:"w-5 h-5"}),t==="ru"?"Пропустить":"O'tkazish"]})]}):e.jsx("button",{onClick:()=>o(null),className:"w-full py-4 bg-gray-100 hover:bg-gray-200 rounded-xl font-bold",children:t==="ru"?"Сканировать ещё":"Yana skanerlash"})]}),!s.code&&e.jsxs("div",{className:"p-6",children:[e.jsx("p",{className:"text-center text-gray-600 mb-4",children:t==="ru"?"QR-код не является пропуском или повреждён":"QR-kod ruxsatnoma emas yoki buzilgan"}),e.jsx("button",{onClick:()=>o(null),className:"w-full py-4 bg-gray-100 hover:bg-gray-200 rounded-xl font-bold",children:t==="ru"?"Сканировать ещё":"Yana skanerlash"})]})]}),g&&e.jsxs("div",{className:"glass-card",children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between",children:[e.jsx("h3",{className:"font-bold",children:t==="ru"?"История сканирований":"Skanerlash tarixi"}),e.jsx("button",{onClick:()=>Q(!1),className:"p-2 hover:bg-gray-100 rounded-xl",children:e.jsx(E,{className:"w-5 h-5"})})]}),q.length===0?e.jsx("div",{className:"p-8 text-center text-gray-500",children:t==="ru"?"История пуста":"Tarix bo'sh"}):e.jsx("div",{className:"divide-y",children:q.map(a=>{const r=a.action==="entry_allowed"||a.action==="scan_success",i=a.action==="entry_denied";return e.jsxs("div",{className:"p-4 flex items-start gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${r?"bg-green-100 text-green-600":i?"bg-red-100 text-red-600":"bg-amber-100 text-amber-600"}`,children:r?e.jsx(S,{className:"w-5 h-5"}):i?e.jsx(T,{className:"w-5 h-5"}):e.jsx(B,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:p[a.visitorType].icon}),e.jsx("span",{className:"font-medium truncate",children:a.residentName})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[t==="ru"?"кв.":"xona"," ",a.residentApartment]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(a.timestamp).toLocaleString(t==="ru"?"ru-RU":"uz-UZ")})]})]},a.id)})})]})]})}export{be as GuardQRScannerPage};
//# sourceMappingURL=GuardQRScannerPage-1768936274458-I8tGyI_9.js.map
